# 后台首页报表部署实施指南

## 一、概述

本文档详细说明后台首页报表功能的部署实施步骤，包括数据库优化、代码部署、权限配置等内容。

---

## 二、准备工作

### 2.1 环境要求

- **JDK**: 1.8+
- **MySQL**: 5.7+
- **Redis**: (可选，用于缓存)
- **项目**: daming-admin

### 2.2 文件清单

确认以下文件已创建：

#### 数据库文件
- `sql/2025-11-22/3-后台首页报表索引优化.sql`

#### 后端文件
- `dm_questionBank/src/main/java/com/dm/quiz/dto/dashboard/*.java` (6个DTO文件)
- `dm_questionBank/src/main/java/com/dm/quiz/mapper/DashboardMapper.java`
- `dm_questionBank/src/main/resources/mapper/quiz/DashboardMapper.xml`
- `dm_questionBank/src/main/java/com/dm/quiz/service/IDashboardService.java`
- `dm_questionBank/src/main/java/com/dm/quiz/service/impl/DashboardServiceImpl.java`
- `ruoyi-admin/src/main/java/com/ruoyi/web/controller/dashboard/DashboardController.java`

#### 文档文件
- `doc/service/2025-11-22/4-后台首页报表规划文档.md`
- `doc/service/2025-11-22/5-后台首页报表API接口文档.md`
- `doc/service/2025-11-22/6-后台首页报表部署实施指南.md`

---

## 三、部署步骤

### 3.1 数据库优化

#### 步骤1: 备份数据库

```bash
# 备份当前数据库
mysqldump -u root -p ry-vue > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 步骤2: 执行索引优化脚本

```bash
# 连接到数据库
mysql -u root -p ry-vue

# 执行索引优化脚本
source e:/区块链比赛/区块链赛前B站笔记++++/Spring系列/个人项目实战/刷题项目/project/daming-admin/sql/2025-11-22/3-后台首页报表索引优化.sql
```

或者在MySQL客户端中直接执行SQL文件内容。

#### 步骤3: 验证索引创建

```sql
-- 检查各表的索引是否创建成功
SHOW INDEX FROM sys_logininfor;
SHOW INDEX FROM daming_paper_answer;
SHOW INDEX FROM daming_question_favorite;
SHOW INDEX FROM daming_question;
SHOW INDEX FROM daming_paper;
SHOW INDEX FROM sys_user;
SHOW INDEX FROM sys_oper_log;
SHOW INDEX FROM daming_question_answer;
```

---

### 3.2 后端代码部署

#### 步骤1: 编译项目

```bash
# 进入项目根目录
cd e:/区块链比赛/区块链赛前B站笔记++++/Spring系列/个人项目实战/刷题项目/project/daming-admin

# 清理并编译项目
mvn clean package -DskipTests
```

#### 步骤2: 检查编译结果

确认编译成功，没有报错。常见问题：
- 如果提示找不到类，检查import语句是否正确
- 如果提示Mapper接口找不到，检查XML文件的namespace是否正确
- 如果提示依赖缺失，执行 `mvn clean install` 重新安装依赖

#### 步骤3: 启动服务

```bash
# 方式1: 使用启动脚本
cd daming-admin
./ry.sh start

# 方式2: 直接运行jar包
cd ruoyi-admin/target
java -jar ruoyi-admin.jar

# 方式3: 在IDE中运行
# 运行 ruoyi-admin 模块的 RuoYiApplication 类
```

#### 步骤4: 验证服务启动

查看控制台日志，确认服务正常启动：
```
Started RuoYiApplication in XX seconds
```

---

### 3.3 权限配置

#### 步骤1: 登录系统

使用管理员账号登录后台管理系统。

#### 步骤2: 创建菜单

进入 **系统管理 > 菜单管理**，创建以下菜单：

**1. 数据大屏菜单**
- 菜单名称: 数据大屏
- 菜单类型: 目录(M)
- 路由地址: dashboard
- 组件路径: 空
- 显示排序: 1
- 菜单图标: dashboard

**2. 首页统计子菜单**
- 上级菜单: 数据大屏
- 菜单名称: 首页统计
- 菜单类型: 菜单(C)
- 路由地址: index
- 组件路径: dashboard/index
- 权限标识: dashboard:overview:query,dashboard:user-activity:query,dashboard:exam-statistics:query,dashboard:question-statistics:query,dashboard:paper-statistics:query,dashboard:time-distribution:query
- 显示排序: 1

#### 步骤3: 分配权限

进入 **系统管理 > 角色管理**，为相应角色分配数据大屏菜单权限。

---

### 3.4 接口测试

#### 方式1: 使用Postman测试

1. 登录获取Token
```http
POST http://localhost:8080/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

2. 测试概览统计接口
```http
GET http://localhost:8080/dashboard/overview
Authorization: Bearer YOUR_TOKEN
```

3. 依次测试其他接口

#### 方式2: 使用cURL测试

```bash
# 1. 获取Token
TOKEN=$(curl -X POST "http://localhost:8080/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.token')

# 2. 测试接口
curl -X GET "http://localhost:8080/dashboard/overview" \
  -H "Authorization: Bearer $TOKEN"
```

#### 方式3: 使用Swagger测试

访问 `http://localhost:8080/swagger-ui.html`，在线测试接口。

---

## 四、功能验证

### 4.1 数据准确性验证

#### 验证1: 总数统计

手动执行以下SQL，与接口返回数据对比：

```sql
-- 验证用户总数
SELECT COUNT(*) FROM sys_user WHERE del_flag = '0';

-- 验证题目总数
SELECT COUNT(*) FROM daming_question WHERE del_flag = 0;

-- 验证试卷总数
SELECT COUNT(*) FROM daming_paper WHERE del_flag = 0;

-- 验证考试总次数
SELECT COUNT(*) FROM daming_paper_answer;
```

#### 验证2: 趋势数据

检查登录趋势和考试趋势的日期范围和数据连续性。

#### 验证3: TOP榜单

确认热门试卷和热门收藏题目的排序是否正确。

### 4.2 性能验证

#### 测试1: 响应时间

使用JMeter或Postman Collection Runner测试接口响应时间：
- 目标: 每个接口响应时间 < 2秒
- 并发: 10用户同时访问

#### 测试2: 数据库查询性能

在MySQL中执行EXPLAIN分析查询计划：

```sql
EXPLAIN SELECT COUNT(*) FROM sys_user WHERE del_flag = '0';
```

确保索引被正确使用(type字段不为ALL)。

### 4.3 边界情况测试

- **无数据情况**: 清空测试表，验证接口是否正常返回空数据
- **大数据量**: 插入大量测试数据，验证性能是否可接受
- **异常数据**: 测试NULL值、负数等异常情况

---

## 五、前端集成

### 5.1 创建前端页面

在 `daming-front/src/views/` 目录下创建 `dashboard` 文件夹：

```
dashboard/
  ├── index.vue           # 主页面
  ├── components/
  │   ├── OverviewCard.vue     # 概览卡片组件
  │   ├── LoginTrend.vue       # 登录趋势图表
  │   ├── ExamTrend.vue        # 考试趋势图表
  │   ├── QuestionChart.vue    # 题目分布图表
  │   ├── PaperRanking.vue     # 试卷排行榜
  │   └── TimeChart.vue        # 时间分布图表
```

### 5.2 安装依赖

```bash
cd daming-front

# 安装ECharts
npm install echarts --save
```

### 5.3 创建API文件

在 `src/api/` 目录下创建 `dashboard.js`：

```javascript
import request from '@/utils/request'

// 获取概览统计
export function getOverview() {
  return request({
    url: '/dashboard/overview',
    method: 'get'
  })
}

// 获取用户活跃度
export function getUserActivity() {
  return request({
    url: '/dashboard/user-activity',
    method: 'get'
  })
}

// 获取考试统计
export function getExamStatistics() {
  return request({
    url: '/dashboard/exam-statistics',
    method: 'get'
  })
}

// 获取题目统计
export function getQuestionStatistics() {
  return request({
    url: '/dashboard/question-statistics',
    method: 'get'
  })
}

// 获取试卷统计
export function getPaperStatistics() {
  return request({
    url: '/dashboard/paper-statistics',
    method: 'get'
  })
}

// 获取时间分布
export function getTimeDistribution() {
  return request({
    url: '/dashboard/time-distribution',
    method: 'get'
  })
}
```

### 5.4 配置路由

在 `src/router/index.js` 中添加路由：

```javascript
{
  path: '/dashboard',
  component: Layout,
  redirect: '/dashboard/index',
  children: [
    {
      path: 'index',
      component: () => import('@/views/dashboard/index'),
      name: 'Dashboard',
      meta: { title: '数据大屏', icon: 'dashboard' }
    }
  ]
}
```

---

## 六、监控与维护

### 6.1 日志监控

#### 查看应用日志

```bash
# 查看实时日志
tail -f logs/sys-info.log

# 查看错误日志
tail -f logs/sys-error.log

# 搜索特定关键词
grep "dashboard" logs/sys-info.log
```

#### 关注日志内容

- SQL执行时间
- 接口响应时间
- 异常堆栈信息

### 6.2 数据库监控

#### 慢查询日志

```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

#### 索引使用情况

```sql
-- 查看索引统计
SELECT 
  TABLE_NAME,
  INDEX_NAME,
  CARDINALITY
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'ry-vue'
  AND TABLE_NAME IN (
    'sys_logininfor',
    'daming_paper_answer',
    'daming_question',
    'daming_paper'
  );
```

### 6.3 性能优化建议

#### 缓存优化

如果接口响应慢，可以考虑集成Redis缓存：

1. 在 `application.yml` 中配置Redis
2. 在Service方法上添加 `@Cacheable` 注解
3. 设置合理的缓存过期时间

示例：
```java
@Cacheable(value = "dashboard:overview", unless = "#result == null")
public OverviewStatisticsDto getOverviewStatistics() {
    // ...
}
```

#### 定时任务预热

创建定时任务定期刷新统计数据：

```java
@Scheduled(cron = "0 */5 * * * ?") // 每5分钟执行一次
public void refreshDashboardCache() {
    dashboardService.getOverviewStatistics();
    dashboardService.getUserActivity();
    // ...
}
```

---

## 七、常见问题

### 7.1 接口返回401

**原因**: Token过期或未传递

**解决方案**:
1. 检查请求头是否包含 `Authorization: Bearer TOKEN`
2. 重新登录获取新Token
3. 检查Token是否正确

### 7.2 接口返回403

**原因**: 权限不足

**解决方案**:
1. 检查菜单管理中是否添加了权限标识
2. 检查用户角色是否分配了相应权限
3. 确认权限标识拼写是否正确

### 7.3 数据统计不准确

**原因**: 索引未创建或数据异常

**解决方案**:
1. 执行 `SHOW INDEX` 确认索引已创建
2. 检查数据表中是否有异常数据
3. 手动执行SQL验证统计逻辑

### 7.4 接口响应慢

**原因**: 数据量大或索引未生效

**解决方案**:
1. 使用 `EXPLAIN` 分析查询计划
2. 确认索引是否被使用
3. 考虑添加Redis缓存
4. 优化SQL查询逻辑

### 7.5 编译报错

**原因**: 依赖缺失或包路径错误

**解决方案**:
1. 执行 `mvn clean install` 重新安装依赖
2. 检查import语句是否正确
3. 确认XML文件的namespace是否正确
4. 刷新IDE项目

---

## 八、回滚方案

如果部署出现问题，可以按以下步骤回滚：

### 8.1 数据库回滚

```sql
-- 删除新增的索引
ALTER TABLE sys_logininfor DROP INDEX idx_login_time;
ALTER TABLE sys_logininfor DROP INDEX idx_user_name;
-- ... 删除其他索引
```

### 8.2 代码回滚

```bash
# 使用Git回滚
git log --oneline  # 查看提交历史
git revert <commit-id>  # 回滚到指定版本

# 或者恢复备份
# 将之前备份的代码覆盖当前代码
```

### 8.3 服务重启

```bash
# 停止服务
./ry.sh stop

# 启动旧版本服务
java -jar ruoyi-admin-old.jar
```

---

## 九、上线检查清单

部署前请确认以下项目已完成：

- [ ] 数据库已备份
- [ ] 索引优化SQL已执行并验证
- [ ] 代码已编译通过
- [ ] 权限菜单已配置
- [ ] 接口测试已通过
- [ ] 数据准确性已验证
- [ ] 性能测试已通过
- [ ] 前端页面已创建(如需要)
- [ ] 文档已更新
- [ ] 监控告警已配置

---

## 十、联系方式

如遇到问题，请联系开发团队或查阅以下文档：
- 规划文档: `doc/service/2025-11-22/4-后台首页报表规划文档.md`
- API文档: `doc/service/2025-11-22/5-后台首页报表API接口文档.md`

---

**文档版本**: v1.0  
**创建日期**: 2025-11-22  
**维护人员**: Cascade
