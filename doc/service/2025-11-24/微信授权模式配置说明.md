# 微信扫码登录授权模式配置说明

## 一、支持的两种授权模式

### 模式1：静默授权 (base) ⭐推荐

**配置值**: `base` 或 `snsapi_base`

**特点**:
- ✅ 已关注用户扫码后**自动完成登录**，无需点击
- ✅ 用户体验最好（已关注用户）
- ✅ 完全免费
- ⚠️ 只能获取 openId，无法获取昵称头像
- ⚠️ 用户名显示为 `wx_xxxxx`
- ⚠️ 首次关注用户在部分微信版本可能需要点击链接

**适用场景**:
- 追求极致用户体验（已关注用户）
- 不需要展示用户真实昵称头像
- 希望减少用户操作步骤

---

### 模式2：完整授权 (userinfo)

**配置值**: `userinfo` 或 `snsapi_userinfo`

**特点**:
- ✅ 可以获取用户昵称、头像、性别等详细信息
- ✅ 用户体验更好（显示真实昵称）
- ⚠️ 需要用户**点击授权链接**
- ⚠️ 需要用户**确认授权**（首次）

**适用场景**:
- 需要展示用户真实昵称头像
- 需要个性化用户体验
- 可以接受用户点击一次授权

---

## 二、配置方法

### 方法1：在 application.yml 中配置（推荐）

```yaml
# 微信公众号配置
wx:
  mp:
    enabled: true
    callback: https://paperback.zww0891.fun
    
    # ⭐ 授权模式配置（重点）
    authScope: base  # 静默授权（默认，推荐）
    # authScope: userinfo  # 完整授权（需要用户点击）
    
    configs:
      - appId: wxeac644b6acef0405
        secret: 22681f0abf2490d0853b5675905b557b
        token: b3337731ab0711ef8c1fe79208535f88
        aesKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
```

### 方法2：通过命令行参数指定

```bash
# 使用静默授权
java -jar ruoyi-admin.jar --wx.mp.authScope=base

# 使用完整授权
java -jar ruoyi-admin.jar --wx.mp.authScope=userinfo
```

### 方法3：通过环境变量指定

```bash
# 设置环境变量
export WX_MP_AUTHSCOPE=base
# 或
export WX_MP_AUTHSCOPE=userinfo

# 启动应用
java -jar ruoyi-admin.jar
```

在 application.yml 中引用：
```yaml
wx:
  mp:
    authScope: ${WX_MP_AUTHSCOPE:base}  # 从环境变量读取，默认base
```

---

## 三、两种模式的用户体验对比

### 静默授权 (base)

**流程**:
```
扫码 → 关注公众号 → 收到"正在为您自动登录..." 
→ 自动完成授权（已关注用户）→ 跳转首页
```

**用户看到的消息**:
```
✅ 感谢关注「大明刷题」！

正在为您自动登录，请稍候...

如未自动登录，请点击：立即登录
```

---

### 完整授权 (userinfo)

**流程**:
```
扫码 → 关注公众号 → 收到"请点击下方链接完成登录" 
→ 点击链接 → 确认授权 → 跳转首页
```

**用户看到的消息**:
```
✅ 感谢关注「大明刷题」！

请点击下方链接完成登录：
📱 点击授权登录
```

---

## 四、配置对照表

| 配置项 | 静默授权 (base) | 完整授权 (userinfo) |
|--------|----------------|-------------------|
| **配置值** | `base` | `userinfo` |
| **授权URL** | `scope=snsapi_base` | `scope=snsapi_userinfo` |
| **是否需要点击** | ❌ 否（已关注用户） | ✅ 是 |
| **是否需要确认** | ❌ 否 | ✅ 是（首次） |
| **获取openId** | ✅ 是 | ✅ 是 |
| **获取昵称** | ❌ 否 | ✅ 是 |
| **获取头像** | ❌ 否 | ✅ 是 |
| **用户名显示** | wx_xxxxx | 真实昵称 |

---

## 五、快速切换步骤

### 切换到静默授权（推荐）

1. **修改配置文件**
   ```yaml
   wx:
     mp:
       authScope: base
   ```

2. **重启应用**
   ```bash
   kill -15 <PID>
   nohup java -jar ruoyi-admin.jar > app.log 2>&1 &
   ```

3. **测试**
   - 使用已关注的微信扫码
   - 应该看到"正在为您自动登录..."
   - 自动完成登录（无需点击）

---

### 切换到完整授权

1. **修改配置文件**
   ```yaml
   wx:
     mp:
       authScope: userinfo
   ```

2. **重启应用**
   ```bash
   kill -15 <PID>
   nohup java -jar ruoyi-admin.jar > app.log 2>&1 &
   ```

3. **测试**
   - 使用已关注的微信扫码
   - 应该看到"请点击下方链接完成登录"
   - 点击链接完成授权
   - 可以看到用户真实昵称

---

## 六、后端日志查看

### 静默授权日志
```log
2025-11-24 11:00:00 INFO  使用静默授权模式 - URL: https://open.weixin.qq.com/...scope=snsapi_base...
2025-11-24 11:00:01 INFO  推送授权消息 - eventType: subscribe, authMode: 静默授权(snsapi_base)
2025-11-24 11:00:02 INFO  获取access_token成功 - openId: o2VPg7QV..., scope: snsapi_base
2025-11-24 11:00:02 INFO  静默授权，只获取到openId: o2VPg7QV...
```

### 完整授权日志
```log
2025-11-24 11:00:00 INFO  使用完整授权模式 - URL: https://open.weixin.qq.com/...scope=snsapi_userinfo...
2025-11-24 11:00:01 INFO  推送授权消息 - eventType: subscribe, authMode: 完整授权(snsapi_userinfo)
2025-11-24 11:00:05 INFO  获取access_token成功 - openId: o2VPg7QV..., scope: snsapi_userinfo
2025-11-24 11:00:05 INFO  获取微信用户详细信息成功 - openId: o2VPg7QV..., nickname: 张三
```

---

## 七、常见问题

### Q1: 修改配置后不生效？
**A**: 必须重启应用才能生效。配置是在应用启动时读取的。

### Q2: 静默授权模式下，首次关注用户也需要点击链接？
**A**: 是的，部分微信版本对首次关注用户的静默授权有限制。已关注用户再次扫码时会自动完成授权。

### Q3: 如何确认当前使用的是哪种模式？
**A**: 查看后端日志，扫码时会输出：`使用静默授权模式` 或 `使用完整授权模式`

### Q4: 可以动态切换模式吗？
**A**: 目前需要修改配置并重启应用。如需动态切换，可以考虑添加管理后台配置功能。

### Q5: 两种模式的安全性有区别吗？
**A**: 没有区别。两种模式都是微信官方提供的标准授权方式，安全性相同。

---

## 八、推荐配置

### 开发环境
```yaml
wx:
  mp:
    authScope: base  # 静默授权，方便测试
```

### 生产环境（方案A - 推荐）
```yaml
wx:
  mp:
    authScope: base  # 静默授权，用户体验最好（已关注用户）
```

### 生产环境（方案B）
```yaml
wx:
  mp:
    authScope: userinfo  # 完整授权，可获取用户昵称头像
```

---

## 九、总结

| 选择标准 | 推荐模式 |
|---------|---------|
| 追求最佳用户体验 | **base（静默授权）** ⭐ |
| 需要显示用户昵称头像 | userinfo（完整授权） |
| 大部分用户已关注 | **base（静默授权）** ⭐ |
| 首次使用的新用户居多 | userinfo（完整授权） |
| 预算有限，追求免费方案 | **base（静默授权）** ⭐ |

**当前默认配置**: `base`（静默授权）

**建议**: 先使用默认的静默授权，根据实际用户反馈决定是否切换。
