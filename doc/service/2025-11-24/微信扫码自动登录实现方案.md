# 微信扫码自动登录实现方案

## 一、方案对比

| 方案 | 实现方式 | 用户体验 | 成本 | 是否需要用户操作 | 推荐度 |
|------|---------|---------|------|----------------|--------|
| **方案1：静默授权** | snsapi_base | ⭐⭐⭐⭐ | 免费 | 已关注用户无需操作 | ⭐⭐⭐⭐⭐ |
| 方案2：完整授权 | snsapi_userinfo | ⭐⭐⭐ | 免费 | 需要点击授权 | ⭐⭐⭐ |
| 方案3：开放平台 | 网站应用扫码登录 | ⭐⭐⭐⭐⭐ | 300元/年 | 无需操作 | ⭐⭐⭐⭐ |

## 二、当前实现：静默授权（推荐）

### 2.1 实现原理

```
┌────────┐         ┌─────────┐         ┌──────────┐
│ 用户   │         │ 公众号  │         │  后端    │
└───┬────┘         └────┬────┘         └────┬─────┘
    │                   │                   │
    │ 1. 扫描二维码     │                   │
    ├──────────────────>│                   │
    │                   │                   │
    │ 2. 关注公众号     │                   │
    │    (首次)         │ 3. SCAN事件       │
    ├──────────────────>├──────────────────>│
    │                   │                   │
    │                   │ 4. 推送静默授权URL │
    │ 5. 收到授权链接   │<──────────────────┤
    │<──────────────────┤                   │
    │                   │                   │
    │ 6. 自动访问链接   │                   │
    │   (无需点击)      │ 7. 授权回调       │
    ├───────────────────┴──────────────────>│
    │                                        │
    │                   8. 生成Token         │
    │                   9. WebSocket通知    │
    │<───────────────────────────────────────┤
    │                                        │
    │ 10. 自动跳转到首页                     │
    └────────────────────────────────────────┘
```

### 2.2 关键代码

#### ScanHandler.java（扫码事件处理）
```java
// 静默授权URL（只获取openId，无需用户确认）
public static final String URL_BASE = 
    "https://open.weixin.qq.com/connect/oauth2/authorize?" +
    "appid=%s&redirect_uri=%s&response_type=code&scope=snsapi_base&state=%s#wechat_redirect";

// 推送授权链接
String authorizeUrl = String.format(URL_BASE, 
    appId, 
    URLEncoder.encode(redirectUri),
    sceneId);

// 根据事件类型返回不同的消息
if ("subscribe".equals(eventType)) {
    // 首次关注
    content = "✅ 感谢关注「大明刷题」！\n\n" +
             "正在为您自动登录，请稍候...\n\n" +
             "如未自动登录，请点击：<a href=\"" + authorizeUrl + "\">立即登录</a>";
} else {
    // 已关注用户扫码
    content = "✅ 正在为您自动登录，请稍候...\n\n" +
             "如未自动登录，请点击：<a href=\"" + authorizeUrl + "\">立即登录</a>";
}
```

#### WxPortalController.java（授权回调处理）
```java
// 根据scope判断授权类型
String scope = accessToken.getScope();

if ("snsapi_userinfo".equals(scope)) {
    // 完整授权：获取用户详细信息
    userInfo = wxMpService.getOAuth2Service().getUserInfo(accessToken, "zh_CN");
} else {
    // 静默授权（snsapi_base）：只获取openId
    userInfo = new WxOAuth2UserInfo();
    userInfo.setOpenid(accessToken.getOpenId());
}
```

### 2.3 优点
✅ **已关注用户扫码后自动完成授权**  
✅ **无需用户点击或确认**  
✅ **完全免费**  
✅ **实现简单**

### 2.4 缺点
❌ **首次关注时，部分微信版本可能需要点击链接**  
❌ **只能获取openId，无法获取昵称头像**  
❌ **用户名显示为 wx_xxxxx**

---

## 三、方案2：完整授权（原方案）

### 3.1 实现方式
```java
// 完整授权URL（获取用户信息，需要用户确认）
public static final String URL_USERINFO = 
    "https://open.weixin.qq.com/connect/oauth2/authorize?" +
    "appid=%s&redirect_uri=%s&response_type=code&scope=snsapi_userinfo&state=%s#wechat_redirect";
```

### 3.2 优点
✅ **可以获取用户昵称、头像等信息**  
✅ **用户体验更好（显示真实昵称）**

### 3.3 缺点
❌ **需要用户点击授权链接**  
❌ **需要用户确认授权**

### 3.4 适用场景
- 需要展示用户真实昵称头像
- 用户不介意点击一次授权

---

## 四、方案3：微信开放平台扫码登录（最佳体验）

### 4.1 实现原理
- 使用微信开放平台的**网站应用**扫码登录
- 类似于QQ登录、微博登录
- 扫码后自动完成授权，无需点击

### 4.2 申请流程

1. **注册微信开放平台账号**
   - 访问：https://open.weixin.qq.com/
   - 注册并完成开发者资质认证（300元/年）

2. **创建网站应用**
   - 登录开放平台
   - 进入"管理中心" → "网站应用"
   - 点击"创建网站应用"
   - 填写应用信息：
     - 应用名称：大明刷题
     - 应用网站：https://paperback.zww0891.fun
     - 授权回调域：paperback.zww0891.fun

3. **获取AppID和AppSecret**
   - 审核通过后，获取网站应用的AppID和AppSecret
   - 注意：这个AppID与公众号的AppID不同

### 4.3 代码实现

#### 前端生成二维码
```javascript
// 微信开放平台扫码登录URL
const WECHAT_OPEN_LOGIN_URL = 'https://open.weixin.qq.com/connect/qrconnect';

// 构建登录URL
const loginUrl = `${WECHAT_OPEN_LOGIN_URL}?` +
  `appid=${APPID}` +
  `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
  `&response_type=code` +
  `&scope=snsapi_login` +
  `&state=${STATE}#wechat_redirect`;

// 显示二维码
<iframe 
  src={loginUrl}
  frameBorder="0" 
  scrolling="no" 
  width="300px" 
  height="400px">
</iframe>
```

#### 后端处理回调
```java
@GetMapping("/wechat/open/callback")
public String openCallback(@RequestParam String code) {
    // 1. 通过code获取access_token
    String url = "https://api.weixin.qq.com/sns/oauth2/access_token?" +
        "appid=" + APPID +
        "&secret=" + SECRET +
        "&code=" + code +
        "&grant_type=authorization_code";
    
    // 2. 获取用户信息
    String userInfoUrl = "https://api.weixin.qq.com/sns/userinfo?" +
        "access_token=" + accessToken +
        "&openid=" + openId;
    
    // 3. 创建用户并返回Token
    // ...
}
```

### 4.4 优点
✅ **扫码后自动完成授权，无需任何操作**  
✅ **可以获取用户完整信息**  
✅ **用户体验最佳**  
✅ **适合网站应用**

### 4.5 缺点
❌ **需要300元/年认证费用**  
❌ **需要企业资质或个体工商户**  
❌ **需要单独申请网站应用**

---

## 五、部署和测试

### 5.1 后端部署
```bash
# 1. 重新打包
cd daming-admin
mvn clean package -DskipTests

# 2. 上传到服务器
scp ruoyi-admin/target/ruoyi-admin.jar root@server:/opt/app/

# 3. 重启服务
kill -15 <PID>
nohup java -jar ruoyi-admin.jar > app.log 2>&1 &
```

### 5.2 前端部署（如需修改）
```bash
# 1. 打包
cd daming-front
npm run build

# 2. 上传到服务器
scp -r dist/* root@server:/www/wwwroot/paperBack.zww0891.fun/dist/
```

### 5.3 测试流程

#### 测试1：首次关注用户
1. 使用未关注的微信扫码
2. 点击"关注公众号"
3. 观察是否收到"正在为您自动登录..."消息
4. 检查是否自动跳转到首页
5. 查看后端日志确认授权类型为 `snsapi_base`

#### 测试2：已关注用户
1. 使用已关注的微信扫码
2. 观察是否立即收到"正在为您自动登录..."消息
3. 检查是否自动完成登录（无需点击）
4. 查看后端日志确认静默授权成功

#### 测试3：WebSocket通知
1. 打开浏览器控制台
2. 扫码后观察WebSocket消息
3. 应该看到 `SCANNED` 和 `SUCCESS:token` 消息

### 5.4 常见问题排查

#### 问题1：扫码后没有收到消息
```bash
# 检查后端日志
tail -f /opt/app/app.log | grep "用户扫码"

# 检查微信公众平台配置
1. 服务器地址(URL): https://paperback.zww0891.fun/wx/portal/public
2. Token是否一致
3. 消息加解密方式是否正确
```

#### 问题2：收到消息但没有自动跳转
```bash
# 检查是否是静默授权
tail -f /opt/app/app.log | grep "scope"

# 应该看到: scope: snsapi_base
# 如果是 snsapi_userinfo，说明配置错误
```

#### 问题3：WebSocket连接失败
```bash
# 检查Nginx配置
location /ws/ {
    proxy_pass http://127.0.0.1:8080/ws/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

---

## 六、推荐方案

### 6.1 预算有限（推荐：方案1）
- 使用**静默授权(snsapi_base)**
- 已实现，代码已提交
- 已关注用户扫码后自动登录
- 完全免费

### 6.2 预算充足（推荐：方案3）
- 使用**微信开放平台扫码登录**
- 用户体验最佳
- 费用：300元/年
- 需要额外开发

### 6.3 需要用户昵称头像（推荐：方案2）
- 使用**完整授权(snsapi_userinfo)**
- 可以获取用户详细信息
- 需要用户点击一次授权
- 完全免费

---

## 七、官方文档参考

1. **微信公众平台开发文档**
   - 网页授权：https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html
   - 带参数二维码：https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html

2. **微信开放平台开发文档**
   - 网站应用微信登录：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html

3. **微信公众平台测试号**
   - 申请地址：https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login
   - 可用于开发测试

---

## 八、总结

当前已实现**方案1：静默授权**，实现了扫码后自动登录的功能：

✅ 已修改 `ScanHandler.java`，使用 `snsapi_base` 静默授权  
✅ 已修改 `WxPortalController.java`，支持静默授权回调  
✅ 已关注用户扫码后自动完成登录，无需点击  
✅ 首次关注用户会收到引导消息

**建议**：
- 当前方案适合大部分场景，完全免费
- 如果预算充足且追求极致体验，可以考虑升级到方案3
- 如果需要显示用户真实昵称头像，可以使用方案2

**下一步**：
1. 部署测试当前方案
2. 收集用户反馈
3. 根据反馈决定是否升级方案
