# å¾®ä¿¡æ‰«ç ç™»å½•å®Œæ•´æµç¨‹ä¸æ—¶åºå›¾

## ğŸ“‹ ä¸šåŠ¡æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½çš„å®Œæ•´è°ƒç”¨é“¾è·¯ï¼ŒåŒ…æ‹¬å‰ç«¯ã€åç«¯ã€å¾®ä¿¡æœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’æµç¨‹ã€‚

---

## ğŸ”„ å®Œæ•´è°ƒç”¨æµç¨‹å›¾

```mermaid
graph TB
    Start([ç”¨æˆ·è®¿é—®ç™»å½•é¡µ]) --> A[å‰ç«¯ç”ŸæˆäºŒç»´ç ]
    
    subgraph "å‰ç«¯ - daming-front"
        A --> B[WebSocketè¿æ¥å»ºç«‹]
        B --> C[å‘é€ request_qrcode æ¶ˆæ¯]
        C --> D[ç­‰å¾…äºŒç»´ç URL]
        D --> E[æ”¶åˆ°URLåç”ŸæˆäºŒç»´ç ]
        E --> F[æ˜¾ç¤ºäºŒç»´ç ç»™ç”¨æˆ·]
    end
    
    subgraph "åç«¯ - WebSocketå±‚"
        C --> G[WxLoginWebSocketHandler<br/>æ¥æ”¶è¯·æ±‚]
        G --> H[ç”ŸæˆsceneId]
        H --> I[ä¿å­˜æ‰«ç è®°å½•åˆ°æ•°æ®åº“]
        I --> J[è°ƒç”¨å¾®ä¿¡APIç”ŸæˆäºŒç»´ç ]
        J --> K[è¿”å›äºŒç»´ç URLç»™å‰ç«¯]
    end
    
    K --> D
    
    F --> L{ç”¨æˆ·æ‰«ç }
    
    subgraph "å¾®ä¿¡æœåŠ¡å™¨"
        L --> M[è¯†åˆ«äºŒç»´ç å‚æ•°]
        M --> N{ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨}
        N -->|æœªå…³æ³¨| O[æ¨é€subscribeäº‹ä»¶]
        N -->|å·²å…³æ³¨| P[æ¨é€SCANäº‹ä»¶]
    end
    
    subgraph "åç«¯ - å›è°ƒæ¥å£"
        O --> Q[WxPortalController.post<br/>æ¥æ”¶å¾®ä¿¡å›è°ƒ]
        P --> Q
        Q --> R[éªŒè¯ç­¾å]
        R --> S[è§£æXMLæ¶ˆæ¯]
        S --> T[wxMpMessageRouter.route<br/>æ¶ˆæ¯è·¯ç”±åˆ†å‘]
    end
    
    subgraph "åç«¯ - æ¶ˆæ¯è·¯ç”±å™¨"
        T --> U{åŒ¹é…è·¯ç”±è§„åˆ™}
        U -->|subscribeäº‹ä»¶| V[ScanHandler.handle]
        U -->|SCANäº‹ä»¶| V
    end
    
    subgraph "åç«¯ - ScanHandler"
        V --> W[è§£æopenIdå’ŒsceneId]
        W --> X[æŸ¥è¯¢æ‰«ç è®°å½•]
        X --> Y{æˆæƒæ¨¡å¼?}
        
        Y -->|userinfoæ¨¡å¼| Z1[å‘é€SCANNEDæ¶ˆæ¯]
        Z1 --> Z2[è¿”å›å¾®ä¿¡æ¶ˆæ¯:<br/>è¯·ç‚¹å‡»é“¾æ¥æˆæƒ]
        
        Y -->|baseæ¨¡å¼| AA[æ ¹æ®openIdåˆ›å»º/æŸ¥è¯¢ç”¨æˆ·]
        AA --> AB[ç”ŸæˆJWT Token]
        AB --> AC[æ›´æ–°æ‰«ç è®°å½•ä¸ºæˆåŠŸ]
        AC --> AD[WebSocketå‘é€<br/>SUCCESS:token]
        AD --> AE[è¿”å›å¾®ä¿¡æ¶ˆæ¯:<br/>æ­£åœ¨è‡ªåŠ¨ç™»å½•]
    end
    
    subgraph "å‰ç«¯ - ç™»å½•å¤„ç†"
        AD --> AF[handleWxMessage<br/>æ”¶åˆ°SUCCESSæ¶ˆæ¯]
        AF --> AG[æå–token]
        AG --> AH[ä¿å­˜tokenåˆ°localStorage]
        AH --> AI[è°ƒç”¨GetInfoè·å–ç”¨æˆ·ä¿¡æ¯]
        AI --> AJ[è·³è½¬é¦–é¡µ]
    end
    
    Z2 --> End1([ç”¨æˆ·éœ€æ‰‹åŠ¨ç‚¹å‡»])
    AJ --> End2([ç™»å½•æˆåŠŸ])
    
    style A fill:#e1f5ff
    style G fill:#fff4e1
    style Q fill:#ffe1e1
    style V fill:#e1ffe1
    style AF fill:#e1f5ff
```

---

## â±ï¸ æ—¶åºå›¾

### åœºæ™¯1ï¼šbaseæ¨¡å¼ - å·²å…³æ³¨ç”¨æˆ·æ‰«ç ï¼ˆæœ€å¿«è·¯å¾„ï¼‰

```mermaid
sequenceDiagram
    actor ç”¨æˆ·
    participant å‰ç«¯
    participant WebSocket
    participant åç«¯API
    participant å¾®ä¿¡æœåŠ¡å™¨
    participant æ¶ˆæ¯è·¯ç”±å™¨
    participant ScanHandler
    participant æ•°æ®åº“
    
    ç”¨æˆ·->>å‰ç«¯: è®¿é—®ç™»å½•é¡µ
    å‰ç«¯->>WebSocket: å»ºç«‹è¿æ¥
    å‰ç«¯->>WebSocket: å‘é€ request_qrcode
    
    WebSocket->>åç«¯API: ç”ŸæˆsceneId
    åç«¯API->>æ•°æ®åº“: ä¿å­˜æ‰«ç è®°å½•
    åç«¯API->>å¾®ä¿¡æœåŠ¡å™¨: è°ƒç”¨APIç”ŸæˆäºŒç»´ç 
    å¾®ä¿¡æœåŠ¡å™¨-->>åç«¯API: è¿”å›äºŒç»´ç URL
    åç«¯API-->>WebSocket: è¿”å›URL
    WebSocket-->>å‰ç«¯: æ¨é€äºŒç»´ç URL
    å‰ç«¯->>å‰ç«¯: ç”Ÿæˆå¹¶æ˜¾ç¤ºäºŒç»´ç 
    
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: æ‰«ç ï¼ˆå·²å…³æ³¨ï¼‰
    
    Note over å¾®ä¿¡æœåŠ¡å™¨: è¯†åˆ«å‚æ•° sceneId
    å¾®ä¿¡æœåŠ¡å™¨->>åç«¯API: POST /wx/portal/public<br/>(æ¨é€SCANäº‹ä»¶)
    
    åç«¯API->>åç«¯API: éªŒè¯ç­¾å
    åç«¯API->>åç«¯API: è§£æXMLæ¶ˆæ¯
    åç«¯API->>æ¶ˆæ¯è·¯ç”±å™¨: route(inMessage)
    
    æ¶ˆæ¯è·¯ç”±å™¨->>æ¶ˆæ¯è·¯ç”±å™¨: åŒ¹é…è§„åˆ™<br/>event=SCAN
    æ¶ˆæ¯è·¯ç”±å™¨->>ScanHandler: handle(message)
    
    ScanHandler->>ScanHandler: è§£æopenIdå’ŒsceneId
    ScanHandler->>æ•°æ®åº“: æŸ¥è¯¢æ‰«ç è®°å½•
    æ•°æ®åº“-->>ScanHandler: è¿”å›sessionId
    
    ScanHandler->>ScanHandler: åˆ¤æ–­authScope=base
    ScanHandler->>æ•°æ®åº“: æ ¹æ®openIdæŸ¥è¯¢ç”¨æˆ·
    æ•°æ®åº“-->>ScanHandler: è¿”å›ç”¨æˆ·ä¿¡æ¯
    
    ScanHandler->>ScanHandler: ç”ŸæˆJWT Token
    ScanHandler->>æ•°æ®åº“: æ›´æ–°æ‰«ç è®°å½•ä¸ºæˆåŠŸ
    
    ScanHandler->>WebSocket: å‘é€ SUCCESS:token
    ScanHandler-->>åç«¯API: è¿”å›XMLå›å¤æ¶ˆæ¯
    åç«¯API-->>å¾®ä¿¡æœåŠ¡å™¨: è¿”å›XML
    
    WebSocket-->>å‰ç«¯: æ¨é€ SUCCESS:token
    å‰ç«¯->>å‰ç«¯: ä¿å­˜token
    å‰ç«¯->>åç«¯API: GetInfoè·å–ç”¨æˆ·ä¿¡æ¯
    åç«¯API-->>å‰ç«¯: è¿”å›ç”¨æˆ·ä¿¡æ¯
    å‰ç«¯->>å‰ç«¯: è·³è½¬é¦–é¡µ
    
    Note over ç”¨æˆ·,å‰ç«¯: âœ… ç™»å½•æˆåŠŸ
```

---

### åœºæ™¯2ï¼šbaseæ¨¡å¼ - é¦–æ¬¡å…³æ³¨æ‰«ç 

```mermaid
sequenceDiagram
    actor ç”¨æˆ·
    participant å‰ç«¯
    participant WebSocket
    participant åç«¯API
    participant å¾®ä¿¡æœåŠ¡å™¨
    participant æ¶ˆæ¯è·¯ç”±å™¨
    participant ScanHandler
    participant æ•°æ®åº“
    
    ç”¨æˆ·->>å‰ç«¯: è®¿é—®ç™»å½•é¡µ
    å‰ç«¯->>WebSocket: å»ºç«‹è¿æ¥å¹¶è·å–äºŒç»´ç 
    Note over å‰ç«¯: (ä¸åœºæ™¯1ç›¸åŒï¼Œçœç•¥)
    å‰ç«¯->>å‰ç«¯: æ˜¾ç¤ºäºŒç»´ç 
    
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: æ‰«ç ï¼ˆæœªå…³æ³¨ï¼‰
    å¾®ä¿¡æœåŠ¡å™¨->>ç”¨æˆ·: æç¤º"å…³æ³¨å…¬ä¼—å·"
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: ç‚¹å‡»å…³æ³¨
    
    Note over å¾®ä¿¡æœåŠ¡å™¨: è¯†åˆ«å‚æ•° qrscene_123456
    å¾®ä¿¡æœåŠ¡å™¨->>åç«¯API: POST /wx/portal/public<br/>(æ¨é€subscribeäº‹ä»¶)
    
    åç«¯API->>åç«¯API: éªŒè¯ç­¾å
    åç«¯API->>åç«¯API: è§£æXMLæ¶ˆæ¯
    åç«¯API->>æ¶ˆæ¯è·¯ç”±å™¨: route(inMessage)
    
    æ¶ˆæ¯è·¯ç”±å™¨->>æ¶ˆæ¯è·¯ç”±å™¨: åŒ¹é…è§„åˆ™<br/>event=SUBSCRIBE
    æ¶ˆæ¯è·¯ç”±å™¨->>ScanHandler: handle(message)
    
    ScanHandler->>ScanHandler: è§£æopenId<br/>ç§»é™¤qrscene_å‰ç¼€
    ScanHandler->>æ•°æ®åº“: æŸ¥è¯¢æ‰«ç è®°å½•
    
    ScanHandler->>ScanHandler: åˆ¤æ–­authScope=base
    ScanHandler->>æ•°æ®åº“: åˆ›å»ºæ–°ç”¨æˆ·<br/>(ç”¨openIdç”Ÿæˆç”¨æˆ·å)
    æ•°æ®åº“-->>ScanHandler: è¿”å›æ–°ç”¨æˆ·ID
    
    ScanHandler->>ScanHandler: ç”ŸæˆJWT Token
    ScanHandler->>æ•°æ®åº“: æ›´æ–°æ‰«ç è®°å½•ä¸ºæˆåŠŸ
    
    ScanHandler->>WebSocket: å‘é€ SUCCESS:token
    ScanHandler-->>åç«¯API: è¿”å›XML:<br/>"æ„Ÿè°¢å…³æ³¨ï¼æ­£åœ¨è‡ªåŠ¨ç™»å½•"
    åç«¯API-->>å¾®ä¿¡æœåŠ¡å™¨: è¿”å›XML
    å¾®ä¿¡æœåŠ¡å™¨->>ç”¨æˆ·: æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    
    WebSocket-->>å‰ç«¯: æ¨é€ SUCCESS:token
    å‰ç«¯->>å‰ç«¯: ä¿å­˜token
    å‰ç«¯->>åç«¯API: GetInfoè·å–ç”¨æˆ·ä¿¡æ¯
    åç«¯API-->>å‰ç«¯: è¿”å›ç”¨æˆ·ä¿¡æ¯
    å‰ç«¯->>å‰ç«¯: è·³è½¬é¦–é¡µ
    
    Note over ç”¨æˆ·,å‰ç«¯: âœ… é¦–æ¬¡å…³æ³¨ç™»å½•æˆåŠŸ
```

---

### åœºæ™¯3ï¼šuserinfoæ¨¡å¼ - éœ€è¦æ‰‹åŠ¨æˆæƒ

```mermaid
sequenceDiagram
    actor ç”¨æˆ·
    participant å‰ç«¯
    participant WebSocket
    participant åç«¯API
    participant å¾®ä¿¡æœåŠ¡å™¨
    participant ScanHandler
    
    ç”¨æˆ·->>å‰ç«¯: è®¿é—®ç™»å½•é¡µ
    Note over å‰ç«¯,WebSocket: è·å–äºŒç»´ç æµç¨‹åŒä¸Š
    
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: æ‰«ç 
    å¾®ä¿¡æœåŠ¡å™¨->>åç«¯API: æ¨é€æ‰«ç äº‹ä»¶
    
    åç«¯API->>ScanHandler: å¤„ç†æ‰«ç äº‹ä»¶
    ScanHandler->>ScanHandler: åˆ¤æ–­authScope=userinfo
    
    ScanHandler->>WebSocket: å‘é€ SCANNED
    ScanHandler-->>åç«¯API: è¿”å›XML:<br/>"è¯·ç‚¹å‡»é“¾æ¥å®Œæˆç™»å½•"
    åç«¯API-->>å¾®ä¿¡æœåŠ¡å™¨: è¿”å›XML
    
    WebSocket-->>å‰ç«¯: æ¨é€ SCANNED
    å‰ç«¯->>å‰ç«¯: æ˜¾ç¤º"å·²æ‰«ç å¾…ç¡®è®¤"é®ç½©
    
    å¾®ä¿¡æœåŠ¡å™¨->>ç”¨æˆ·: æ˜¾ç¤ºæˆæƒé“¾æ¥æ¶ˆæ¯
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: ç‚¹å‡»æˆæƒé“¾æ¥
    å¾®ä¿¡æœåŠ¡å™¨->>ç”¨æˆ·: å¼¹å‡ºæˆæƒç¡®è®¤é¡µé¢
    ç”¨æˆ·->>å¾®ä¿¡æœåŠ¡å™¨: ç¡®è®¤æˆæƒ
    
    å¾®ä¿¡æœåŠ¡å™¨->>åç«¯API: GET /wx/portal/public/callBack?code=xxx
    åç«¯API->>å¾®ä¿¡æœåŠ¡å™¨: ç”¨codeæ¢å–access_token
    å¾®ä¿¡æœåŠ¡å™¨-->>åç«¯API: è¿”å›access_tokenå’Œç”¨æˆ·ä¿¡æ¯
    
    åç«¯API->>åç«¯API: åˆ›å»º/æŸ¥è¯¢ç”¨æˆ·<br/>(åŒ…å«æ˜µç§°ã€å¤´åƒ)
    åç«¯API->>åç«¯API: ç”ŸæˆJWT Token
    åç«¯API->>WebSocket: å‘é€ SUCCESS:token
    
    WebSocket-->>å‰ç«¯: æ¨é€ SUCCESS:token
    å‰ç«¯->>å‰ç«¯: è‡ªåŠ¨ç™»å½•å¹¶è·³è½¬é¦–é¡µ
    
    Note over ç”¨æˆ·,å‰ç«¯: âœ… æˆæƒç™»å½•æˆåŠŸ
```

---

## ğŸ—‚ï¸ æ ¸å¿ƒç±»è¯´æ˜

### å‰ç«¯ (daming-front)

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/views/login/index.vue` | ç™»å½•é¡µé¢ï¼ŒWebSocketè¿æ¥ï¼ŒäºŒç»´ç ç”Ÿæˆ |
| `handleWxMessage()` | å¤„ç†WebSocketæ¶ˆæ¯ï¼š<br/>- äºŒç»´ç URL<br/>- SCANNED<br/>- SUCCESS:token |
| `handleWxLoginSuccess()` | ä¿å­˜tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬é¦–é¡µ |

---

### åç«¯ - WebSocketå±‚ (ruoyi-admin)

| ç±» | ä½œç”¨ |
|---|------|
| `WxLoginWebSocketHandler` | å¤„ç†WebSocketè¿æ¥å’Œæ¶ˆæ¯<br/>- æ¥æ”¶ `request_qrcode`<br/>- ç”ŸæˆsceneId<br/>- è°ƒç”¨å¾®ä¿¡APIç”ŸæˆäºŒç»´ç <br/>- æ¨é€æ¶ˆæ¯ç»™å‰ç«¯ |

---

### åç«¯ - å›è°ƒæ¥å£å±‚ (ruoyi-admin)

| ç±» | æ–¹æ³• | ä½œç”¨ |
|---|------|------|
| `WxPortalController` | `post()` | æ¥æ”¶å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„æ¶ˆæ¯<br/>- éªŒè¯ç­¾å<br/>- è§£æXML<br/>- è°ƒç”¨æ¶ˆæ¯è·¯ç”±å™¨ |

---

### åç«¯ - è·¯ç”±é…ç½®å±‚ (ruoyi-admin)

| ç±» | æ–¹æ³• | ä½œç”¨ |
|---|------|------|
| `WxMpConfiguration` | `messageRouter()` | é…ç½®æ¶ˆæ¯è·¯ç”±è§„åˆ™<br/>- SUBSCRIBE â†’ ScanHandler<br/>- SCAN â†’ ScanHandler |

---

### åç«¯ - ä¸šåŠ¡å¤„ç†å±‚ (ruoyi-admin)

| ç±» | æ–¹æ³• | ä½œç”¨ |
|---|------|------|
| `ScanHandler` | `handle()` | å¤„ç†æ‰«ç äº‹ä»¶<br/>- è§£æopenIdå’ŒsceneId<br/>- åˆ›å»º/æŸ¥è¯¢ç”¨æˆ·<br/>- ç”Ÿæˆtoken<br/>- æ¨é€ç»™å‰ç«¯ |
| `DamingUserService` | `findOrCreateByWxInfo()` | æ ¹æ®openIdåˆ›å»ºæˆ–æŸ¥è¯¢ç”¨æˆ· |
| `TokenService` | `createToken()` | ç”ŸæˆJWT Token |

---

## ğŸ“Š å…³é”®æ•°æ®æµ

### 1. sceneId çš„ç”Ÿæˆä¸ä¼ é€’

```
WebSocketç”ŸæˆsceneId
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ wx_scan_log (scene_id, session_id)
    â†“
ä¼ ç»™å¾®ä¿¡APIç”ŸæˆäºŒç»´ç 
    â†“
ç”¨æˆ·æ‰«ç ï¼Œå¾®ä¿¡è¯†åˆ«sceneId
    â†“
å¾®ä¿¡å›è°ƒæ—¶æºå¸¦ EventKey=sceneId
    â†“
ScanHandlerè§£æsceneId
    â†“
æŸ¥è¯¢æ•°æ®åº“è·å–sessionId
    â†“
é€šè¿‡sessionIdæ‰¾åˆ°å¯¹åº”çš„WebSocketè¿æ¥
    â†“
æ¨é€æ¶ˆæ¯ç»™å‰ç«¯
```

---

### 2. openId çš„ä½œç”¨

```
ç”¨æˆ·æ‰«ç  â†’ å¾®ä¿¡è¯†åˆ«ç”¨æˆ· â†’ æ¨é€openId
    â†“
ScanHandleræ¥æ”¶openId
    â†“
æŸ¥è¯¢æ•°æ®åº“ daming_user (wx_open_id = openId)
    â†“
å¦‚æœå­˜åœ¨ â†’ è¿”å›ç°æœ‰ç”¨æˆ·
å¦‚æœä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·(user_name = wx_openId)
    â†“
ç”Ÿæˆtoken (åŒ…å«user_id)
    â†“
å‰ç«¯ç”¨tokenè®¿é—®API
```

---

### 3. WebSocket çš„åŒå‘é€šä¿¡

**å‰ç«¯ â†’ åç«¯**ï¼š
```javascript
// è¯·æ±‚äºŒç»´ç 
websocket.send('request_qrcode')
```

**åç«¯ â†’ å‰ç«¯**ï¼š
```java
// è¿”å›äºŒç»´ç URL
webSocketHandler.sendMessageToSession(sessionId, "https://...")

// é€šçŸ¥å·²æ‰«ç  (userinfoæ¨¡å¼)
webSocketHandler.sendMessageToSession(sessionId, "SCANNED")

// å‘é€token (baseæ¨¡å¼)
webSocketHandler.sendMessageToSession(sessionId, "SUCCESS:token")
```

---

## ğŸ¯ ä¸¤ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | baseæ¨¡å¼ | userinfoæ¨¡å¼ |
|------|---------|-------------|
| **æˆæƒæ–¹å¼** | é™é»˜æˆæƒ | å®Œæ•´æˆæƒ |
| **ç”¨æˆ·æ“ä½œ** | æ‰«ç å³å¯ | æ‰«ç +ç‚¹å‡»æˆæƒ+ç¡®è®¤ |
| **è·å–ä¿¡æ¯** | åªæœ‰openId | openId+æ˜µç§°+å¤´åƒ |
| **æ˜¯å¦æ˜¾ç¤ºé®ç½©** | âŒ ä¸æ˜¾ç¤º | âœ… æ˜¾ç¤º"å·²æ‰«ç å¾…ç¡®è®¤" |
| **æ˜¯å¦éœ€è¦å›è°ƒ** | âŒ ä¸éœ€è¦ | âœ… éœ€è¦callBackæ¥å£ |
| **ç™»å½•é€Ÿåº¦** | âš¡ æœ€å¿« | â±ï¸ è¾ƒæ…¢ |
| **æƒé™è¦æ±‚** | æµ‹è¯•å·æ”¯æŒ | éœ€è¦æ­£å¼å·æƒé™ |

---

## ğŸ”§ å…³é”®é…ç½®

### application-dev.yml

```yaml
wx:
  mp:
    # å›è°ƒåœ°å€
    callback: http://10xh9vd648325.vicp.fun
    
    # æˆæƒæ¨¡å¼ï¼ˆbase æˆ– userinfoï¼‰
    authScope: base
    
    # å…¬ä¼—å·é…ç½®
    configs:
      - appId: wxeac644b6acef0405
        secret: xxx
        token: xxx
        aesKey: xxx
```

---

### å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®

**æœåŠ¡å™¨é…ç½®**ï¼š
```
URL: http://10xh9vd648325.vicp.fun/wx/portal/public
Token: b3337731ab0711ef8c1fe79208535f88
EncodingAESKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
æ¶ˆæ¯åŠ è§£å¯†æ–¹å¼: å®‰å…¨æ¨¡å¼
```

---

## ğŸ“ æ•°æ®è¡¨

### wx_scan_logï¼ˆæ‰«ç è®°å½•è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| scene_str | varchar | UUIDå­—ç¬¦ä¸² |
| scene_id | int | åœºæ™¯ID |
| session_id | varchar | WebSocketä¼šè¯ID |
| status | int | çŠ¶æ€ï¼š0-å¾…æ‰«ç ï¼Œ1-å·²æ‰«ç ï¼Œ2-æˆåŠŸ |
| wx_open_id | varchar | ç”¨æˆ·openId |
| user_id | int | ç³»ç»Ÿç”¨æˆ·ID |

---

### daming_userï¼ˆç”¨æˆ·è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | bigint | ç”¨æˆ·ID |
| user_name | varchar | ç”¨æˆ·å(wx_openId) |
| wx_open_id | varchar | å¾®ä¿¡openId |
| nick_name | varchar | æ˜µç§° |

---

## ğŸš€ æ€»ç»“

### æ ¸å¿ƒæµç¨‹

1. **å‰ç«¯**ï¼šWebSocketè¿æ¥ â†’ è¯·æ±‚äºŒç»´ç  â†’ æ˜¾ç¤º
2. **ç”¨æˆ·**ï¼šæ‰«ç  â†’ å…³æ³¨ï¼ˆé¦–æ¬¡ï¼‰
3. **å¾®ä¿¡**ï¼šæ¨é€äº‹ä»¶ â†’ åç«¯å›è°ƒæ¥å£
4. **è·¯ç”±**ï¼šåŒ¹é…è§„åˆ™ â†’ åˆ†å‘åˆ°Handler
5. **Handler**ï¼šè§£ææ¶ˆæ¯ â†’ åˆ›å»ºç”¨æˆ· â†’ ç”Ÿæˆtoken â†’ WebSocketæ¨é€
6. **å‰ç«¯**ï¼šæ”¶åˆ°token â†’ ä¿å­˜ â†’ ç™»å½• â†’ è·³è½¬

### æŠ€æœ¯è¦ç‚¹

- âœ… WebSocketå®ç°å‰åç«¯å®æ—¶é€šä¿¡
- âœ… æ¶ˆæ¯è·¯ç”±å™¨è‡ªåŠ¨åˆ†å‘ä¸åŒäº‹ä»¶
- âœ… sceneIdå…³è”å‰ç«¯ä¼šè¯å’Œå¾®ä¿¡å›è°ƒ
- âœ… openIdä½œä¸ºç”¨æˆ·å”¯ä¸€æ ‡è¯†
- âœ… baseæ¨¡å¼å®ç°çœŸæ­£çš„æ‰«ç å³ç™»å½•

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2025-11-24  
**æœ€åæ›´æ–°**ï¼š2025-11-24
