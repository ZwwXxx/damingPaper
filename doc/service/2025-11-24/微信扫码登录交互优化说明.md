# 微信扫码登录交互优化说明

## 🎯 功能说明

根据微信授权模式（`authScope`）自动调整用户交互体验：

| 授权模式 | 用户体验 | 是否显示遮罩 |
|---------|---------|------------|
| **base** (静默授权) | 扫码后自动跳转授权，无需确认 | ❌ 不显示 |
| **userinfo** (完整授权) | 扫码后显示"已扫码待确认"，需手动确认 | ✅ 显示 |

---

## 📋 实现逻辑

### base 模式（推荐）

```yaml
# application-dev.yml 或 application-prod.yml
wx:
  mp:
    authScope: base
```

**用户流程**：
```
1. 用户扫码
   ↓
2. 后端接收到扫码事件
   ↓
3. 后端不发送 SCANNED 消息（关键！）
   ↓
4. 后端推送授权链接给用户微信
   ↓
5. 用户在微信中自动跳转授权页面
   ↓
6. 已关注用户：自动授权完成，立即登录 ✅
   首次关注：需要点击链接，然后自动授权
```

**特点**：
- ✅ 体验流畅，无需额外确认
- ✅ 已关注用户可实现真正的"扫码即登录"
- ✅ 前端不显示"已扫码待确认"遮罩

---

### userinfo 模式

```yaml
# application-dev.yml 或 application-prod.yml
wx:
  mp:
    authScope: userinfo
```

**用户流程**：
```
1. 用户扫码
   ↓
2. 后端接收到扫码事件
   ↓
3. 后端发送 SCANNED 消息给前端（关键！）
   ↓
4. 前端显示"已扫码待确认"遮罩 📱
   ↓
5. 后端推送授权链接给用户微信
   ↓
6. 用户在微信中点击授权链接
   ↓
7. 用户手动确认授权（微信弹窗）
   ↓
8. 登录成功 ✅
```

**特点**：
- ⚠️ 需要用户手动确认授权
- ✅ 可以获取用户昵称、头像等信息
- ✅ 前端显示"已扫码待确认"遮罩，提示用户操作

---

## 🔧 技术实现

### 后端实现（ScanHandler.java）

```java
// ⭐ 根据授权模式决定是否通知前端"已扫码"
if (sessionId != null && "userinfo".equalsIgnoreCase(authScope)) {
    // userinfo模式：发送SCANNED消息，前端显示遮罩
    webSocketHandler.sendMessageToSession(sessionId, "SCANNED");
    log.info("✅ [userinfo模式] 通过WebSocket通知前端已扫码");
} else if (sessionId != null) {
    // base模式：不发送SCANNED消息，用户自动跳转
    log.info("ℹ️ [base模式] 跳过SCANNED通知，用户将自动跳转授权页面");
}
```

**关键点**：
- `authScope = base`：不发送 `SCANNED` 消息
- `authScope = userinfo`：发送 `SCANNED` 消息

---

### 前端实现（login/index.vue）

```vue
<!-- 扫码成功遮罩：仅在收到SCANNED消息时显示 -->
<div v-if="wxScanStatus === 'scanned'" class="qr-scanned-overlay">
  <i class="el-icon-success"></i>
  <p>已扫码，请在手机上确认授权</p>
</div>
```

```javascript
// WebSocket消息处理
handleWxMessage(message) {
  // 扫码状态通知（仅userinfo模式会收到）
  if (message === 'SCANNED') {
    this.wxScanStatus = 'scanned'  // 触发遮罩显示
    this.$message.success('检测到扫码，请在手机上确认授权')
    return
  }
  
  // 登录成功
  if (message.startsWith('SUCCESS:')) {
    const token = message.substring(8)
    this.handleWxLoginSuccess(token)
    return
  }
}
```

**关键点**：
- 只有收到 `SCANNED` 消息才设置 `wxScanStatus = 'scanned'`
- base 模式下不会收到此消息，因此不显示遮罩

---

## 🎨 用户体验对比

### base 模式（静默授权）✅ 推荐

**已关注用户**：
```
扫码 → 微信自动打开授权页面 → 自动授权 → 登录成功
       (无需任何操作，真正的一步完成)
```

**首次关注用户**：
```
扫码 → 收到消息"感谢关注" → 点击链接 → 自动授权 → 登录成功
       (需点击一次链接，但之后不需要确认)
```

---

### userinfo 模式（完整授权）

**所有用户**：
```
扫码 → 前端显示"已扫码待确认"遮罩 → 收到微信消息 → 点击链接 → 手动确认授权 → 登录成功
       (需要两次操作：点击链接 + 确认授权)
```

---

## ⚙️ 配置切换

### 启用 base 模式（推荐）

```yaml
# application-dev.yml
wx:
  mp:
    authScope: base  # ← 静默授权
```

**效果**：
- ❌ 不显示"已扫码待确认"遮罩
- ✅ 扫码后自动跳转授权
- ✅ 已关注用户无感登录

---

### 启用 userinfo 模式

```yaml
# application-dev.yml
wx:
  mp:
    authScope: userinfo  # ← 完整授权
```

**效果**：
- ✅ 显示"已扫码待确认"遮罩
- ⚠️ 需要用户手动确认
- ✅ 可获取用户昵称头像

---

## 📊 模式选择建议

### 推荐使用 base 模式

**理由**：
1. ✅ **用户体验最佳**
   - 已关注用户：扫码即登录，无需任何操作
   - 首次用户：只需点击一次链接

2. ✅ **权限足够**
   - 可获取用户 openId
   - 可识别用户身份
   - 满足登录需求

3. ✅ **技术优势**
   - 微信测试公众号完全支持
   - 无需特殊权限
   - 稳定可靠

---

### 何时使用 userinfo 模式

**适用场景**：
- 需要获取用户昵称、头像等详细信息
- 需要正式公众号权限支持
- 希望用户明确感知授权过程

**注意事项**：
- ⚠️ 微信测试公众号的 userinfo 权限可能受限
- ⚠️ 用户体验相对复杂
- ⚠️ 需要用户手动确认授权

---

## 🔍 问题排查

### Q1: base 模式下仍显示"已扫码待确认"遮罩？

**排查步骤**：
1. 确认配置文件中 `authScope: base`
2. 重启应用
3. 查看启动日志，确认加载的配置：
   ```log
   ✅ 授权模式(authScope): base
   ```
4. 扫码后查看后端日志：
   ```log
   ℹ️ [base模式] 跳过SCANNED通知
   ```

如果看到这条日志，说明配置正确。

---

### Q2: userinfo 模式下不显示遮罩？

**排查步骤**：
1. 确认配置文件中 `authScope: userinfo`
2. 重启应用
3. 扫码后查看后端日志：
   ```log
   ✅ [userinfo模式] 通过WebSocket通知前端已扫码
   ```
4. 检查浏览器控制台，是否收到 `SCANNED` 消息

---

### Q3: 扫码后微信没有自动打开链接？

**原因**：
- 微信客户端版本或设置问题
- 链接格式问题
- base 模式下已关注用户通常会自动打开

**解决方法**：
- 检查微信公众平台"网页授权域名"配置
- 用户手动点击微信收到的链接即可

---

## ✅ 验证清单

### base 模式验证

**已关注用户**：
- [ ] 扫码后前端**不显示**"已扫码待确认"遮罩
- [ ] 微信自动打开授权页面（或显示消息提示点击）
- [ ] 自动完成授权，无需手动确认
- [ ] 前端自动登录成功

**首次关注用户**：
- [ ] 扫码后前端**不显示**"已扫码待确认"遮罩
- [ ] 收到"感谢关注"消息
- [ ] 点击链接后自动授权
- [ ] 前端自动登录成功

---

### userinfo 模式验证

**所有用户**：
- [ ] 扫码后前端**显示**"已扫码待确认"遮罩 ✅
- [ ] 收到消息提示"请点击完成登录"
- [ ] 点击链接后需要手动确认授权 ⚠️
- [ ] 确认后前端自动登录成功

---

## 🎉 总结

### 配置简单

```yaml
# 只需配置一个参数
authScope: base    # 或 userinfo
```

### 体验智能

- **base 模式**：自动优化体验，无需用户额外操作
- **userinfo 模式**：显示遮罩提示，引导用户确认

### 代码解耦

- 后端根据配置决定是否发送 `SCANNED` 消息
- 前端根据消息自动调整 UI 显示
- 无需修改多处代码即可切换模式

---

## 📖 相关文档

- [微信授权模式配置说明.md](./微信授权模式配置说明.md)
- [微信公众号多环境配置说明.md](./微信公众号多环境配置说明.md)
- [微信扫码自动登录实现方案.md](./微信扫码自动登录实现方案.md)

---

**推荐配置**：使用 `authScope: base`，体验最佳！✨
