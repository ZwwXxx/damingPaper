# 微信公众号多环境配置说明

## 📋 配置概览

项目现在支持不同环境使用不同的微信公众号：

| 环境 | AppID | 说明 |
|------|-------|------|
| **开发环境 (dev)** | wxeac644b6acef0405 | 用于本地开发和测试 |
| **生产环境 (prod)** | wxc261f8090267a8f5 | 用于线上正式环境 |

---

## 🎯 配置结构

### application-dev.yml（开发环境）
```yaml
wx:
  mp:
    callback: http://10xh9vd648325.vicp.fun  # 内网穿透地址
    authScope: base
    configs:
      - appId: wxeac644b6acef0405      # 开发公众号
        secret: 22681f0abf2490d0853b5675905b557b
        token: b3337731ab0711ef8c1fe79208535f88
        aesKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
```

### application-prod.yml（生产环境）
```yaml
wx:
  mp:
    callback: https://paperback.zww0891.fun  # 线上域名
    authScope: base
    configs:
      - appId: wxc261f8090267a8f5      # 生产公众号
        secret: 22681f0abf2490d0853b5675905b557b
        token: b3337731ab0711ef8c1fe79208535f88
        aesKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
```

---

## ✅ 验证配置

### 启动时查看日志

**开发环境**：
```log
========================================
微信公众号配置加载成功
========================================
✅ 回调地址(callback): http://10xh9vd648325.vicp.fun
✅ 授权模式(authScope): base
✅ 公众号数量: 1
   - AppId: wxeac644b6acef0405  ← 开发公众号
     Token: b333****535f88
     Secret: 2268****5b557b
========================================
```

**生产环境**：
```log
========================================
微信公众号配置加载成功
========================================
✅ 回调地址(callback): https://paperback.zww0891.fun
✅ 授权模式(authScope): base
✅ 公众号数量: 1
   - AppId: wxc261f8090267a8f5  ← 生产公众号
     Token: b333****535f88
     Secret: 2268****5b557b
========================================
```

---

## 🔄 环境切换

### IDEA 开发
```
Run/Debug Configurations
→ Active profiles: druid,dev
→ 启动后自动使用: wxeac644b6acef0405
```

### 本地测试生产配置
```
Run/Debug Configurations
→ Active profiles: druid,prod
→ 启动后自动使用: wxc261f8090267a8f5
```

### 命令行启动
```bash
# 开发环境
java -jar ruoyi-admin.jar --spring.profiles.active=druid,dev
# 使用: wxeac644b6acef0405

# 生产环境
java -jar ruoyi-admin.jar --spring.profiles.active=druid,prod
# 使用: wxc261f8090267a8f5
```

---

## 📝 修改公众号配置

### 如果两个公众号的 secret/token/aesKey 不同

**修改 application-dev.yml**：
```yaml
configs:
  - appId: wxeac644b6acef0405
    secret: 开发公众号的secret    # ← 修改这里
    token: 开发公众号的token      # ← 修改这里
    aesKey: 开发公众号的aesKey    # ← 修改这里
```

**修改 application-prod.yml**：
```yaml
configs:
  - appId: wxc261f8090267a8f5
    secret: 生产公众号的secret    # ← 修改这里
    token: 生产公众号的token      # ← 修改这里
    aesKey: 生产公众号的aesKey    # ← 修改这里
```

---

## 🔧 微信公众平台配置

### 开发公众号配置（wxeac644b6acef0405）

**服务器配置（开发与生产模式）**：
```
URL: http://10xh9vd648325.vicp.fun/wx/portal/public
Token: b3337731ab0711ef8c1fe79208535f88
EncodingAESKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
消息加解密方式: 安全模式
```

### 生产公众号配置（wxc261f8090267a8f5）

**服务器配置（开发与生产模式）**：
```
URL: https://paperback.zww0891.fun/wx/portal/public
Token: b3337731ab0711ef8c1fe79208535f88
EncodingAESKey: Hha4Su7QiNUEdj1jow5oQZtcIXVshfUXSClXRCpD1am
消息加解密方式: 安全模式
```

---

## 🚀 部署流程

### 开发环境部署

1. **打包**
   ```bash
   mvn clean package -DskipTests
   ```

2. **启动**
   ```bash
   java -jar ruoyi-admin.jar --spring.profiles.active=druid,dev
   ```

3. **验证**
   - 查看启动日志确认 AppId: wxeac644b6acef0405
   - 扫码测试登录功能

### 生产环境部署

1. **打包**
   ```bash
   mvn clean package -DskipTests
   ```

2. **上传到服务器**
   ```bash
   scp target/ruoyi-admin.jar root@server:/opt/app/
   ```

3. **启动**
   ```bash
   ./bin/run-prod.sh
   # 或
   java -jar ruoyi-admin.jar --spring.profiles.active=druid,prod
   ```

4. **验证**
   - 查看启动日志确认 AppId: wxc261f8090267a8f5
   - 扫码测试登录功能

---

## ⚠️ 注意事项

### 1. 两个公众号需要分别配置服务器URL

**开发公众号（wxeac644b6acef0405）**：
- 需要在微信公众平台配置 `http://10xh9vd648325.vicp.fun/wx/portal/public`
- 需要启动内网穿透工具

**生产公众号（wxc261f8090267a8f5）**：
- 需要在微信公众平台配置 `https://paperback.zww0891.fun/wx/portal/public`
- 需要域名解析到服务器IP

### 2. 关注哪个公众号就用哪个登录

- 用户关注**开发公众号** → 只能在开发环境登录
- 用户关注**生产公众号** → 只能在生产环境登录
- 两个公众号的粉丝数据**互不相通**

### 3. 测试时注意环境

```bash
# ❌ 错误：开发环境启动，但扫描生产公众号二维码
java -jar app.jar --spring.profiles.active=druid,dev
# 此时生成的二维码是开发公众号的，不能扫描生产公众号

# ✅ 正确：开发环境启动，扫描开发公众号二维码
java -jar app.jar --spring.profiles.active=druid,dev
# 二维码和公众号匹配
```

---

## 📊 配置优先级

```
application-prod.yml (configs)    ← 最高优先级
    ↓ 覆盖
application-dev.yml (configs)
    ↓ 覆盖
application.yml (configs)         ← 最低优先级
```

**建议**：
- ✅ 环境配置（dev/prod）中配置 `configs`
- ✅ 主配置（application.yml）中可以保留默认配置或注释掉

---

## 🎯 常见问题

### Q1: 启动时显示的 AppId 不对？
**A**: 检查 Active profiles 是否正确：
- 开发环境应该是 `druid,dev`
- 生产环境应该是 `druid,prod`

### Q2: 扫码后提示"该公众号暂时无法提供服务"？
**A**: 检查以下几点：
1. 微信公众平台的服务器URL是否正确配置
2. 内网穿透（开发）或域名解析（生产）是否正常
3. 当前启动的环境是否与公众号匹配

### Q3: 如何在本地测试生产公众号？
**A**: 
```bash
# 启动时指定 prod profile
java -jar ruoyi-admin.jar --spring.profiles.active=druid,prod
```
注意：需要修改 `callback` 为可访问的地址。

### Q4: 两个公众号可以同时使用吗？
**A**: 不建议。每个环境只使用一个公众号，避免混淆。

---

## 📖 相关文档

- [环境配置切换指南.md](./环境配置切换指南.md)
- [微信授权模式配置说明.md](./微信授权模式配置说明.md)
- [微信扫码自动登录实现方案.md](./微信扫码自动登录实现方案.md)

---

## 🎉 总结

**配置完成后**：
- ✅ 开发环境自动使用 `wxeac644b6acef0405`
- ✅ 生产环境自动使用 `wxc261f8090267a8f5`
- ✅ 无需手动修改，启动时自动切换
- ✅ 两个环境互不影响，独立运行

**验证成功标志**：
```log
# 开发环境启动
AppId: wxeac644b6acef0405  ✅

# 生产环境启动
AppId: wxc261f8090267a8f5  ✅
```
