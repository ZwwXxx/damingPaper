# 微信扫码登录前端对接指南

## 一、环境准备

### 1.1 安装依赖

```bash
npm install qrcode
# 或者
yarn add qrcode
```

## 二、Vue3实现示例

### 2.1 创建登录页面组件

```vue
<template>
  <div class="wx-login-container">
    <div class="login-box">
      <h2>微信扫码登录</h2>
      <div class="qrcode-wrapper">
        <!-- 二维码显示区域 -->
        <canvas ref="qrcodeCanvas" v-show="qrcodeUrl"></canvas>
        
        <!-- 加载状态 -->
        <div v-show="!qrcodeUrl" class="loading">
          <i class="el-icon-loading"></i>
          <p>二维码生成中...</p>
        </div>
        
        <!-- 错误提示 -->
        <div v-if="errorMsg" class="error-msg">
          {{ errorMsg }}
        </div>
      </div>
      
      <div class="tips">
        <p>请使用微信扫描二维码登录</p>
        <p class="refresh" @click="refreshQrcode">刷新二维码</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from 'vue'
import QRCode from 'qrcode'

// 响应式变量
const qrcodeCanvas = ref(null)
const qrcodeUrl = ref('')
const errorMsg = ref('')
let websocket = null

/**
 * 初始化WebSocket连接
 */
const initWebSocket = () => {
  try {
    // 连接WebSocket服务器
    websocket = new WebSocket('ws://localhost:8080/ws/login')
    
    // 连接成功
    websocket.onopen = () => {
      console.log('WebSocket连接成功')
      errorMsg.value = ''
      // 发送消息请求二维码
      websocket.send('request_qrcode')
    }
    
    // 接收消息
    websocket.onmessage = (event) => {
      console.log('收到消息:', event.data)
      qrcodeUrl.value = event.data
      // 生成二维码
      generateQRCode(event.data)
    }
    
    // 连接关闭
    websocket.onclose = () => {
      console.log('WebSocket连接关闭')
    }
    
    // 连接错误
    websocket.onerror = (error) => {
      console.error('WebSocket错误:', error)
      errorMsg.value = 'WebSocket连接失败，请刷新重试'
    }
  } catch (error) {
    console.error('初始化WebSocket失败:', error)
    errorMsg.value = '初始化失败，请检查服务是否启动'
  }
}

/**
 * 生成二维码
 */
const generateQRCode = async (url) => {
  try {
    await QRCode.toCanvas(qrcodeCanvas.value, url, {
      width: 250,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    })
  } catch (error) {
    console.error('生成二维码失败:', error)
    errorMsg.value = '生成二维码失败'
  }
}

/**
 * 刷新二维码
 */
const refreshQrcode = () => {
  qrcodeUrl.value = ''
  errorMsg.value = ''
  if (websocket && websocket.readyState === WebSocket.OPEN) {
    websocket.send('request_qrcode')
  } else {
    initWebSocket()
  }
}

/**
 * 关闭WebSocket连接
 */
const closeWebSocket = () => {
  if (websocket) {
    websocket.close()
    websocket = null
  }
}

// 组件挂载
onMounted(() => {
  initWebSocket()
})

// 组件卸载
onBeforeUnmount(() => {
  closeWebSocket()
})
</script>

<style scoped>
.wx-login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-box {
  background: white;
  border-radius: 10px;
  padding: 40px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.login-box h2 {
  margin-bottom: 30px;
  color: #333;
  font-size: 24px;
}

.qrcode-wrapper {
  width: 250px;
  height: 250px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
  border: 1px solid #eee;
  border-radius: 8px;
  background: #fafafa;
}

.loading {
  text-align: center;
  color: #999;
}

.loading i {
  font-size: 32px;
  margin-bottom: 10px;
}

.error-msg {
  color: #f56c6c;
  font-size: 14px;
}

.tips {
  margin-top: 20px;
  color: #666;
  font-size: 14px;
}

.tips .refresh {
  color: #409eff;
  cursor: pointer;
  margin-top: 10px;
}

.tips .refresh:hover {
  text-decoration: underline;
}
</style>
```

## 三、Vue2实现示例

### 3.1 使用Options API

```vue
<template>
  <div class="wx-login-container">
    <div class="login-box">
      <h2>微信扫码登录</h2>
      <div class="qrcode-wrapper">
        <canvas ref="qrcodeCanvas" v-show="qrcodeUrl"></canvas>
        <div v-show="!qrcodeUrl" class="loading">
          <i class="el-icon-loading"></i>
          <p>二维码生成中...</p>
        </div>
        <div v-if="errorMsg" class="error-msg">{{ errorMsg }}</div>
      </div>
      <div class="tips">
        <p>请使用微信扫描二维码登录</p>
        <p class="refresh" @click="refreshQrcode">刷新二维码</p>
      </div>
    </div>
  </div>
</template>

<script>
import QRCode from 'qrcode'

export default {
  name: 'WxLogin',
  data() {
    return {
      qrcodeUrl: '',
      errorMsg: '',
      websocket: null
    }
  },
  mounted() {
    this.initWebSocket()
  },
  beforeDestroy() {
    this.closeWebSocket()
  },
  methods: {
    initWebSocket() {
      try {
        this.websocket = new WebSocket('ws://localhost:8080/ws/login')
        
        this.websocket.onopen = () => {
          console.log('WebSocket连接成功')
          this.errorMsg = ''
          this.websocket.send('request_qrcode')
        }
        
        this.websocket.onmessage = (event) => {
          console.log('收到消息:', event.data)
          this.qrcodeUrl = event.data
          this.generateQRCode(event.data)
        }
        
        this.websocket.onclose = () => {
          console.log('WebSocket连接关闭')
        }
        
        this.websocket.onerror = (error) => {
          console.error('WebSocket错误:', error)
          this.errorMsg = 'WebSocket连接失败，请刷新重试'
        }
      } catch (error) {
        console.error('初始化WebSocket失败:', error)
        this.errorMsg = '初始化失败，请检查服务是否启动'
      }
    },
    
    async generateQRCode(url) {
      try {
        await QRCode.toCanvas(this.$refs.qrcodeCanvas, url, {
          width: 250,
          margin: 1,
          color: {
            dark: '#000000',
            light: '#FFFFFF'
          }
        })
      } catch (error) {
        console.error('生成二维码失败:', error)
        this.errorMsg = '生成二维码失败'
      }
    },
    
    refreshQrcode() {
      this.qrcodeUrl = ''
      this.errorMsg = ''
      if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
        this.websocket.send('request_qrcode')
      } else {
        this.initWebSocket()
      }
    },
    
    closeWebSocket() {
      if (this.websocket) {
        this.websocket.close()
        this.websocket = null
      }
    }
  }
}
</script>

<style scoped>
/* 样式同上 */
</style>
```

## 四、React实现示例

### 4.1 函数组件实现

```jsx
import React, { useEffect, useRef, useState } from 'react'
import QRCode from 'qrcode'
import './WxLogin.css'

const WxLogin = () => {
  const canvasRef = useRef(null)
  const [qrcodeUrl, setQrcodeUrl] = useState('')
  const [errorMsg, setErrorMsg] = useState('')
  const websocketRef = useRef(null)

  useEffect(() => {
    initWebSocket()
    
    return () => {
      closeWebSocket()
    }
  }, [])

  const initWebSocket = () => {
    try {
      websocketRef.current = new WebSocket('ws://localhost:8080/ws/login')
      
      websocketRef.current.onopen = () => {
        console.log('WebSocket连接成功')
        setErrorMsg('')
        websocketRef.current.send('request_qrcode')
      }
      
      websocketRef.current.onmessage = (event) => {
        console.log('收到消息:', event.data)
        setQrcodeUrl(event.data)
        generateQRCode(event.data)
      }
      
      websocketRef.current.onclose = () => {
        console.log('WebSocket连接关闭')
      }
      
      websocketRef.current.onerror = (error) => {
        console.error('WebSocket错误:', error)
        setErrorMsg('WebSocket连接失败，请刷新重试')
      }
    } catch (error) {
      console.error('初始化WebSocket失败:', error)
      setErrorMsg('初始化失败，请检查服务是否启动')
    }
  }

  const generateQRCode = async (url) => {
    try {
      await QRCode.toCanvas(canvasRef.current, url, {
        width: 250,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      })
    } catch (error) {
      console.error('生成二维码失败:', error)
      setErrorMsg('生成二维码失败')
    }
  }

  const refreshQrcode = () => {
    setQrcodeUrl('')
    setErrorMsg('')
    if (websocketRef.current && websocketRef.current.readyState === WebSocket.OPEN) {
      websocketRef.current.send('request_qrcode')
    } else {
      initWebSocket()
    }
  }

  const closeWebSocket = () => {
    if (websocketRef.current) {
      websocketRef.current.close()
      websocketRef.current = null
    }
  }

  return (
    <div className="wx-login-container">
      <div className="login-box">
        <h2>微信扫码登录</h2>
        <div className="qrcode-wrapper">
          <canvas ref={canvasRef} style={{ display: qrcodeUrl ? 'block' : 'none' }} />
          {!qrcodeUrl && (
            <div className="loading">
              <i className="loading-icon"></i>
              <p>二维码生成中...</p>
            </div>
          )}
          {errorMsg && <div className="error-msg">{errorMsg}</div>}
        </div>
        <div className="tips">
          <p>请使用微信扫描二维码登录</p>
          <p className="refresh" onClick={refreshQrcode}>刷新二维码</p>
        </div>
      </div>
    </div>
  )
}

export default WxLogin
```

## 五、配置说明

### 5.1 环境变量配置

开发环境 `.env.development`:
```env
VITE_WS_URL=ws://localhost:8080/ws/login
```

生产环境 `.env.production`:
```env
VITE_WS_URL=wss://your-domain.com/ws/login
```

### 5.2 使用环境变量

```javascript
const WS_URL = import.meta.env.VITE_WS_URL || 'ws://localhost:8080/ws/login'
const websocket = new WebSocket(WS_URL)
```

## 六、注意事项

### 6.1 WebSocket连接
- 确保后端服务已启动
- 检查端口号是否正确
- 生产环境使用wss协议

### 6.2 二维码刷新
- 二维码有效期1小时
- 建议添加定时刷新机制
- 用户可手动刷新

### 6.3 错误处理
- 捕获WebSocket连接异常
- 捕获二维码生成异常
- 给用户友好的错误提示

### 6.4 安全建议
- 生产环境使用HTTPS/WSS
- 添加请求频率限制
- 验证消息来源

## 七、扩展功能

### 7.1 添加倒计时

```javascript
const [countdown, setCountdown] = useState(3600) // 1小时

useEffect(() => {
  const timer = setInterval(() => {
    setCountdown(prev => {
      if (prev <= 1) {
        clearInterval(timer)
        refreshQrcode()
        return 3600
      }
      return prev - 1
    })
  }, 1000)
  
  return () => clearInterval(timer)
}, [])
```

### 7.2 添加自动刷新

```javascript
useEffect(() => {
  // 55分钟后自动刷新
  const timer = setTimeout(() => {
    refreshQrcode()
  }, 55 * 60 * 1000)
  
  return () => clearTimeout(timer)
}, [qrcodeUrl])
```

## 八、调试技巧

### 8.1 查看WebSocket连接状态

```javascript
console.log('WebSocket状态:', {
  CONNECTING: 0,
  OPEN: 1,
  CLOSING: 2,
  CLOSED: 3,
  current: websocket.readyState
})
```

### 8.2 测试二维码

使用在线工具扫描二维码测试URL格式:
- [草料二维码](https://cli.im/)
- 微信扫一扫

---

**文档版本**: v1.0  
**创建日期**: 2025-11-23  
**作者**: 系统管理员
