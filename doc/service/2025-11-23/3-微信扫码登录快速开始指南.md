# å¾®ä¿¡æ‰«ç ç™»å½•å¿«é€Ÿå¼€å§‹æŒ‡å—

## ä¸€ã€åç«¯é…ç½®æ­¥éª¤

### æ­¥éª¤1: æ·»åŠ ä¾èµ–

ä¾èµ–å·²è‡ªåŠ¨æ·»åŠ åˆ° `pom.xml`ï¼Œæ‰§è¡ŒMavenæ›´æ–°:

```bash
mvn clean install
```

### æ­¥éª¤2: é…ç½®å¾®ä¿¡å‚æ•°

å¤åˆ¶é…ç½®ç¤ºä¾‹æ–‡ä»¶:
```bash
cd ruoyi-admin/src/main/resources
cp application-wx.yml.example application-wx.yml
```

ç¼–è¾‘ `application-wx.yml`ï¼Œå¡«å…¥çœŸå®é…ç½®:

```yaml
wx:
  mp:
    callback: http://your-domain.com  # æ”¹ä¸ºä½ çš„åŸŸå
    configs:
      - appId: wxxxxxxxxxxxxxxxxxxx      # æ”¹ä¸ºä½ çš„AppID
        secret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  # æ”¹ä¸ºä½ çš„AppSecret
        token: your_token_here          # æ”¹ä¸ºä½ çš„Token
        aesKey: your_aes_key_here       # æ”¹ä¸ºä½ çš„AESKey(å¯é€‰)
```

åœ¨ä¸»é…ç½®æ–‡ä»¶ `application.yml` ä¸­å¼•å…¥:

```yaml
spring:
  profiles:
    include: wx
```

### æ­¥éª¤3: æ‰§è¡Œæ•°æ®åº“è„šæœ¬

æ‰§è¡ŒSQLè„šæœ¬æ‰©å±•ç”¨æˆ·è¡¨:

```bash
mysql -u root -p your_database < sql/2025-11-23/7-å¾®ä¿¡æ‰«ç ç™»å½•ç”¨æˆ·è¡¨æ‰©å±•.sql
```

æˆ–è€…åœ¨æ•°æ®åº“å·¥å…·ä¸­æ‰‹åŠ¨æ‰§è¡Œ:

```sql
-- æ·»åŠ å¾®ä¿¡ç›¸å…³å­—æ®µ
ALTER TABLE sys_user ADD COLUMN wx_open_id VARCHAR(64) NULL COMMENT 'å¾®ä¿¡OpenID' AFTER email;
ALTER TABLE sys_user ADD COLUMN wx_nickname VARCHAR(50) NULL COMMENT 'å¾®ä¿¡æ˜µç§°' AFTER wx_open_id;
ALTER TABLE sys_user ADD COLUMN wx_avatar VARCHAR(500) NULL COMMENT 'å¾®ä¿¡å¤´åƒURL' AFTER wx_nickname;
ALTER TABLE sys_user ADD UNIQUE INDEX idx_wx_open_id (wx_open_id);
```

### æ­¥éª¤4: é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°

1. è®¿é—® [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"å¼€å‘" -> "åŸºæœ¬é…ç½®"
3. é…ç½®æœåŠ¡å™¨åœ°å€:
   - **URL**: `http://your-domain.com/wx/portal/public`
   - **Token**: ä¸é…ç½®æ–‡ä»¶ä¸­çš„tokenä¿æŒä¸€è‡´
   - **EncodingAESKey**: ç‚¹å‡»"éšæœºç”Ÿæˆ"
4. ç‚¹å‡»"æäº¤"å‰ï¼Œç¡®ä¿åº”ç”¨å·²å¯åŠ¨
5. æäº¤åæ˜¾ç¤º"é…ç½®æˆåŠŸ"

### æ­¥éª¤5: å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

æˆ–è€…ä½¿ç”¨IDEå¯åŠ¨ `RuoYiApplication` ç±»ã€‚

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤WebSocketæœåŠ¡å¯åŠ¨:
```
WebSocketç«¯ç‚¹æ³¨å†ŒæˆåŠŸ: /ws/login
Spring Bootåº”ç”¨å¯åŠ¨åœ¨ç«¯å£: 8080
```

## äºŒã€å‰ç«¯é…ç½®æ­¥éª¤

### æ­¥éª¤1: å®‰è£…ä¾èµ–

åœ¨å‰ç«¯é¡¹ç›®ä¸­å®‰è£…äºŒç»´ç åº“:

```bash
npm install qrcode
```

### æ­¥éª¤2: åˆ›å»ºç™»å½•ç»„ä»¶

åˆ›å»ºæ–‡ä»¶ `src/views/login/wxLogin.vue`:

```vue
<template>
  <div class="wx-login">
    <h2>å¾®ä¿¡æ‰«ç ç™»å½•</h2>
    <canvas ref="qrcodeCanvas"></canvas>
    <p>è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç </p>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from 'vue'
import QRCode from 'qrcode'

const qrcodeCanvas = ref(null)
let websocket = null

onMounted(() => {
  websocket = new WebSocket('ws://localhost:8080/ws/login')
  
  websocket.onopen = () => {
    websocket.send('request_qrcode')
  }
  
  websocket.onmessage = (event) => {
    QRCode.toCanvas(qrcodeCanvas.value, event.data, { width: 250 })
  }
})

onBeforeUnmount(() => {
  if (websocket) websocket.close()
})
</script>

<style scoped>
.wx-login {
  text-align: center;
  padding: 50px;
}
</style>
```

### æ­¥éª¤3: æ·»åŠ è·¯ç”±

åœ¨ `router/index.js` ä¸­æ·»åŠ è·¯ç”±:

```javascript
{
  path: '/wx-login',
  name: 'WxLogin',
  component: () => import('@/views/login/wxLogin.vue')
}
```

### æ­¥éª¤4: æµ‹è¯•è®¿é—®

æµè§ˆå™¨è®¿é—®: `http://localhost:8080/wx-login`

åº”è¯¥èƒ½çœ‹åˆ°äºŒç»´ç æ˜¾ç¤ºã€‚

## ä¸‰ã€æµ‹è¯•æµç¨‹

### 1. éªŒè¯åç«¯æœåŠ¡

æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨:

```bash
# æ£€æŸ¥HTTPæœåŠ¡
curl http://localhost:8080/wx/portal/public

# æ£€æŸ¥WebSocketæœåŠ¡
wscat -c ws://localhost:8080/ws/login
```

### 2. éªŒè¯å¾®ä¿¡é…ç½®

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°åå°æŸ¥çœ‹"æ¥å£é…ç½®ä¿¡æ¯"æ˜¯å¦æ˜¾ç¤º"å·²å¯ç”¨"ã€‚

### 3. æµ‹è¯•æ‰«ç æµç¨‹

1. æ‰“å¼€å‰ç«¯ç™»å½•é¡µé¢
2. ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç 
3. ç‚¹å‡»æˆæƒé“¾æ¥
4. æŸ¥çœ‹æ˜¯å¦è·³è½¬åˆ°ç™»å½•æˆåŠŸé¡µé¢

### 4. æŸ¥çœ‹æ—¥å¿—

åç«¯æ—¥å¿—åº”æ˜¾ç¤º:

```
æ”¶åˆ°WebSocketæ¶ˆæ¯: request_qrcode
äºŒç»´ç ç”ŸæˆæˆåŠŸ,åœºæ™¯å€¼: 123456789, URL: https://...
æ”¶åˆ°å¾®ä¿¡æˆæƒå›è°ƒ,code: 071abc...
è·å–access_tokenæˆåŠŸ: ...
è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ - openId: ..., nickname: ..., headImgUrl: ...
```

## å››ã€å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: WebSocketè¿æ¥å¤±è´¥

**ç°è±¡**: å‰ç«¯æ§åˆ¶å°æ˜¾ç¤º `WebSocket connection failed`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
2. ç¡®è®¤ç«¯å£8080æœªè¢«å ç”¨
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. ç¡®è®¤WebSocketé…ç½®å·²åŠ è½½

```bash
# Windowsæ£€æŸ¥ç«¯å£
netstat -ano | findstr 8080

# Linuxæ£€æŸ¥ç«¯å£
netstat -tulnp | grep 8080
```

### é—®é¢˜2: äºŒç»´ç ç”Ÿæˆå¤±è´¥

**ç°è±¡**: åç«¯æ—¥å¿—æ˜¾ç¤º `ç”ŸæˆäºŒç»´ç å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥å¾®ä¿¡é…ç½®æ˜¯å¦æ­£ç¡®
2. éªŒè¯AppIDå’ŒSecretæ˜¯å¦æœ‰æ•ˆ
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

```bash
# å¼€å¯DEBUGæ—¥å¿—
logging:
  level:
    com.ruoyi: DEBUG
    me.chanjar.weixin: DEBUG
```

### é—®é¢˜3: æ‰«ç æ— ååº”

**ç°è±¡**: æ‰«ç åæ²¡æœ‰æ”¶åˆ°æˆæƒé“¾æ¥

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤å…¬ä¼—å·å·²é…ç½®æœåŠ¡å™¨åœ°å€
2. æ£€æŸ¥å›è°ƒåœ°å€æ˜¯å¦å¤–ç½‘å¯è®¿é—®
3. æŸ¥çœ‹ScanHandleræ—¥å¿—
4. éªŒè¯Tokenæ˜¯å¦ä¸€è‡´

### é—®é¢˜4: æˆæƒå¤±è´¥

**ç°è±¡**: ç‚¹å‡»æˆæƒåæ˜¾ç¤ºé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥å›è°ƒåœ°å€é…ç½®
2. ç¡®è®¤scopeå‚æ•°æ­£ç¡®
3. æŸ¥çœ‹å¾®ä¿¡è¿”å›çš„é”™è¯¯ç 

```java
// åœ¨WxPortalControllerä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
log.error("å¾®ä¿¡æˆæƒå¤±è´¥,é”™è¯¯ç : {}, é”™è¯¯ä¿¡æ¯: {}", 
    e.getError().getErrorCode(), e.getError().getErrorMsg());
```

## äº”ã€å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒ

ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·(æ¨ènatappæˆ–ngrok):

```bash
# ä½¿ç”¨natapp
natapp -authtoken=your_token -subdomain=yourname 8080

# ä½¿ç”¨ngrok
ngrok http 8080
```

è·å¾—å¤–ç½‘åœ°å€åï¼Œé…ç½®åˆ° `callback` å’Œå¾®ä¿¡å…¬ä¼—å¹³å°ã€‚

### ç”Ÿäº§ç¯å¢ƒ

1. é…ç½®HTTPSè¯ä¹¦
2. ä¿®æ”¹WebSocketä¸ºWSS
3. é…ç½®Nginxåå‘ä»£ç†

```nginx
# Nginxé…ç½®ç¤ºä¾‹
location / {
    proxy_pass http://localhost:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

## å…­ã€ä¸‹ä¸€æ­¥

å®ŒæˆåŸºç¡€é…ç½®åï¼Œå¯ä»¥è¿›è¡Œä»¥ä¸‹æ‰©å±•:

### 1. å®Œå–„ç™»å½•é€»è¾‘ï¼ˆæ“ä½œdaming_userè¡¨ï¼‰

åœ¨ `WxPortalController.callBack()` æ–¹æ³•ä¸­å®ç°å‰å°ç”¨æˆ·ç™»å½•:

```java
// 1. æ ¹æ®wx_open_idæŸ¥è¯¢daming_userè¡¨
DamingUser user = damingUserService.selectUserByOpenId(userInfo.getOpenid());

// 2. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·
if (user == null) {
    user = new DamingUser();
    // è®¾ç½®ç”¨æˆ·åä¸º wx_ + openIdå8ä½
    user.setUserName("wx_" + userInfo.getOpenid().substring(userInfo.getOpenid().length() - 8));
    // è®¾ç½®æ˜µç§°ä¸ºå¾®ä¿¡æ˜µç§°
    user.setNickName(userInfo.getNickname());
    // è®¾ç½®å¤´åƒä¸ºå¾®ä¿¡å¤´åƒ
    user.setAvatar(userInfo.getHeadImgUrl());
    // è®¾ç½®å¾®ä¿¡ä¿¡æ¯
    user.setWxOpenId(userInfo.getOpenid());
    user.setWxUnionId(userInfo.getUnionId());
    user.setWxNickname(userInfo.getNickname());
    user.setWxAvatar(userInfo.getHeadImgUrl());
    user.setWxBindTime(new Date());
    user.setDelFlag("0");
    // ä¿å­˜åˆ°daming_userè¡¨
    damingUserService.insertUser(user);
} else {
    // 3. å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°å¾®ä¿¡ä¿¡æ¯ï¼ˆæ˜µç§°å’Œå¤´åƒå¯èƒ½å˜åŒ–ï¼‰
    user.setWxNickname(userInfo.getNickname());
    user.setWxAvatar(userInfo.getHeadImgUrl());
    damingUserService.updateUser(user);
}

// 4. ç”Ÿæˆå‰å°ç”¨æˆ·Token
String token = damingTokenService.createToken(user);

// 5. é‡å®šå‘åˆ°å‰å°é¡µé¢å¹¶æºå¸¦token
return "redirect:http://front-domain.com/login-success?token=" + token;
```

### 2. æ·»åŠ è´¦å·ç»‘å®šåŠŸèƒ½ï¼ˆå·²æœ‰daming_userè´¦å·ç»‘å®šå¾®ä¿¡ï¼‰

å…è®¸å·²æ³¨å†Œçš„å‰å°ç”¨æˆ·ç»‘å®šå¾®ä¿¡:

```java
@PostMapping("/bind")
public AjaxResult bindWxAccount(@RequestParam String code) {
    // è·å–å½“å‰ç™»å½•çš„å‰å°ç”¨æˆ·
    DamingUser currentUser = getDamingLoginUser();
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šå¾®ä¿¡
    if (StringUtils.isNotEmpty(currentUser.getWxOpenId())) {
        return AjaxResult.error("è¯¥è´¦å·å·²ç»‘å®šå¾®ä¿¡");
    }
    
    // è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
    WxOAuth2UserInfo userInfo = getWxUserInfo(code);
    
    // æ£€æŸ¥è¯¥å¾®ä¿¡æ˜¯å¦å·²è¢«å…¶ä»–è´¦å·ç»‘å®š
    DamingUser existUser = damingUserService.selectUserByOpenId(userInfo.getOpenid());
    if (existUser != null) {
        return AjaxResult.error("è¯¥å¾®ä¿¡å·²ç»‘å®šå…¶ä»–è´¦å·");
    }
    
    // ç»‘å®šå¾®ä¿¡ä¿¡æ¯åˆ°å½“å‰ç”¨æˆ·
    currentUser.setWxOpenId(userInfo.getOpenid());
    currentUser.setWxUnionId(userInfo.getUnionId());
    currentUser.setWxNickname(userInfo.getNickname());
    currentUser.setWxAvatar(userInfo.getHeadImgUrl());
    currentUser.setWxBindTime(new Date());
    damingUserService.updateUser(currentUser);
    
    return AjaxResult.success("å¾®ä¿¡ç»‘å®šæˆåŠŸ");
}

@PostMapping("/unbind")
public AjaxResult unbindWxAccount() {
    // è·å–å½“å‰ç™»å½•çš„å‰å°ç”¨æˆ·
    DamingUser currentUser = getDamingLoginUser();
    
    // è§£ç»‘å¾®ä¿¡
    currentUser.setWxOpenId(null);
    currentUser.setWxUnionId(null);
    damingUserService.updateUser(currentUser);
    
    return AjaxResult.success("å¾®ä¿¡è§£ç»‘æˆåŠŸ");
}
```

### 3. æ·»åŠ ç™»å½•æ—¥å¿—

è®°å½•ç”¨æˆ·ç™»å½•å†å²:

```java
// è®°å½•ç™»å½•æ—¥å¿—
LoginLog loginLog = new LoginLog();
loginLog.setUserName(user.getUserName());
loginLog.setLoginType("wx_scan");
loginLog.setLoginTime(new Date());
loginLogService.insert(loginLog);
```

## ä¸ƒã€é¡¹ç›®ç»“æ„

å®Œæˆåçš„é¡¹ç›®ç»“æ„:

```
daming-admin/
â”œâ”€â”€ ruoyi-common/
â”‚   â””â”€â”€ src/main/java/com/ruoyi/common/
â”‚       â”œâ”€â”€ config/
â”‚       â”‚   â”œâ”€â”€ WxMpProperties.java       # å¾®ä¿¡é…ç½®å±æ€§
â”‚       â”‚   â””â”€â”€ WxMpConfiguration.java    # å¾®ä¿¡é…ç½®ç±»
â”‚       â””â”€â”€ handler/
â”‚           â””â”€â”€ ScanHandler.java          # æ‰«ç å¤„ç†å™¨
â”œâ”€â”€ ruoyi-admin/
â”‚   â””â”€â”€ src/main/java/com/ruoyi/web/
â”‚       â”œâ”€â”€ controller/wx/
â”‚       â”‚   â””â”€â”€ WxPortalController.java   # å¾®ä¿¡æ§åˆ¶å™¨
â”‚       â””â”€â”€ websocket/
â”‚           â”œâ”€â”€ NettyWebSocketServer.java # WebSocketæœåŠ¡å™¨
â”‚           â”œâ”€â”€ WebSocketInitializer.java # WebSocketåˆå§‹åŒ–
â”‚           â””â”€â”€ WebSocketHandler.java     # WebSocketå¤„ç†å™¨
â”œâ”€â”€ sql/2025-11-23/
â”‚   â””â”€â”€ 7-å¾®ä¿¡æ‰«ç ç™»å½•ç”¨æˆ·è¡¨æ‰©å±•.sql       # æ•°æ®åº“è„šæœ¬
â””â”€â”€ doc/service/2025-11-23/
    â”œâ”€â”€ 1-å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½è®¾è®¡æ–‡æ¡£.md       # åŠŸèƒ½è®¾è®¡æ–‡æ¡£
    â”œâ”€â”€ 2-å¾®ä¿¡æ‰«ç ç™»å½•å‰ç«¯å¯¹æ¥æŒ‡å—.md       # å‰ç«¯å¯¹æ¥æŒ‡å—
    â””â”€â”€ 3-å¾®ä¿¡æ‰«ç ç™»å½•å¿«é€Ÿå¼€å§‹æŒ‡å—.md       # æœ¬æ–‡æ¡£
```

## å…«ã€æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜å¯ä»¥:

1. æŸ¥çœ‹å®Œæ•´çš„åŠŸèƒ½è®¾è®¡æ–‡æ¡£
2. æŸ¥çœ‹å‰ç«¯å¯¹æ¥æŒ‡å—
3. å‚è€ƒå¾®ä¿¡å®˜æ–¹æ–‡æ¡£
4. æŸ¥çœ‹é¡¹ç›®issue

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-23  
**ä½œè€…**: ç³»ç»Ÿç®¡ç†å‘˜  
**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«! ğŸ‰**
