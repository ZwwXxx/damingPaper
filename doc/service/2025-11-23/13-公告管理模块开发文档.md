# 公告管理模块开发文档

## 📋 文档信息

- **创建日期**: 2025-11-23
- **模块名称**: 公告管理
- **开发人员**: daming
- **版本**: v1.0

---

## 📝 功能概述

公告管理模块用于后台管理系统发布和管理前台考试系统的公告信息，支持公告的增删改查、发布/下架、置顶等功能。

### 核心功能

1. **公告CRUD** - 创建、查询、修改、删除公告
2. **发布管理** - 发布/下架公告，草稿保存
3. **置顶功能** - 支持公告置顶显示
4. **分类管理** - 支持通知、公告、活动三种类型
5. **浏览统计** - 自动统计公告浏览次数
6. **前台展示** - 前台系统查看已发布公告

---

## 🗄️ 数据库设计

### 表结构：`daming_notice`

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| notice_id | bigint(20) | 公告ID | 主键，自增 |
| notice_title | varchar(200) | 公告标题 | 必填 |
| notice_content | text | 公告内容 | 必填，支持富文本 |
| notice_type | tinyint(4) | 公告类型 | 1=通知 2=公告 3=活动 |
| is_top | tinyint(1) | 是否置顶 | 0=否 1=是 |
| status | tinyint(4) | 发布状态 | 0=草稿 1=已发布 |
| publish_time | datetime | 发布时间 | 发布时自动设置 |
| sort_order | int(11) | 排序序号 | 数值越大越靠前 |
| view_count | int(11) | 浏览次数 | 自动统计 |
| del_flag | char(1) | 删除标志 | 0=正常 1=删除 |
| create_user | varchar(64) | 创建者 | 自动填充 |
| create_time | datetime | 创建时间 | 自动生成 |
| update_user | varchar(64) | 更新者 | 自动填充 |
| update_time | datetime | 更新时间 | 自动更新 |
| remark | varchar(500) | 备注 | 可选 |

### 索引设计

```sql
-- 主键索引
PRIMARY KEY (`notice_id`)

-- 组合索引：发布状态+置顶+排序
KEY `idx_status_isTop_sort` (`status`, `is_top`, `sort_order`)

-- 创建时间索引
KEY `idx_create_time` (`create_time`)

-- 发布时间索引
KEY `idx_publish_time` (`publish_time`)
```

---

## 🏗️ 后端架构

### 1. 实体类层 (Domain)

**文件**: `DamingNotice.java`
- 继承 `BaseEntity`
- 包含所有字段的getter/setter
- 使用 `@Excel` 注解支持导出功能

### 2. 数据访问层 (Mapper)

#### Mapper接口
**文件**: `DamingNoticeMapper.java`

主要方法：
- `selectDamingNoticeByNoticeId` - 根据ID查询
- `selectDamingNoticeList` - 查询列表（后台）
- `selectPublishedNoticeList` - 查询已发布列表（前台）
- `insertDamingNotice` - 新增
- `updateDamingNotice` - 更新
- `deleteDamingNoticeByNoticeId` - 删除（单个）
- `deleteDamingNoticeByNoticeIds` - 批量删除
- `incrementViewCount` - 增加浏览次数

#### Mapper XML
**文件**: `DamingNoticeMapper.xml`

特色SQL：
```xml
<!-- 后台列表查询 -->
<select id="selectDamingNoticeList">
    SELECT * FROM daming_notice
    WHERE del_flag = '0'
    ORDER BY is_top DESC, sort_order DESC, create_time DESC
</select>

<!-- 前台已发布列表 -->
<select id="selectPublishedNoticeList">
    SELECT * FROM daming_notice
    WHERE status = 1 AND del_flag = '0'
    ORDER BY is_top DESC, sort_order DESC, publish_time DESC
</select>
```

### 3. 业务逻辑层 (Service)

#### Service接口
**文件**: `IDamingNoticeService.java`

#### Service实现
**文件**: `DamingNoticeServiceImpl.java`

核心业务：
- 新增时设置默认值（置顶=否，状态=草稿，浏览=0）
- 发布时自动设置发布时间
- 软删除实现

### 4. 控制器层 (Controller)

#### 后台管理Controller
**文件**: `DamingNoticeController.java`
- 路由：`/quiz/notice`
- 权限控制：`@PreAuthorize`
- 操作日志：`@Log`

主要接口：
| 接口 | 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|------|
| 列表查询 | GET | /list | quiz:notice:list | 分页查询 |
| 详情查询 | GET | /{noticeId} | quiz:notice:query | 根据ID查询 |
| 新增 | POST | / | quiz:notice:add | 创建公告 |
| 修改 | PUT | / | quiz:notice:edit | 更新公告 |
| 删除 | DELETE | /{noticeIds} | quiz:notice:remove | 批量删除 |
| 发布 | PUT | /publish/{noticeId} | quiz:notice:publish | 发布公告 |
| 下架 | PUT | /unpublish/{noticeId} | quiz:notice:unpublish | 取消发布 |
| 导出 | POST | /export | quiz:notice:export | 导出Excel |

#### 前台查看Controller
**文件**: `NoticeController.java`
- 路由：`/student/notice`
- 无需权限验证

主要接口：
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 列表查询 | GET | /list | 查看已发布公告 |
| 详情查询 | GET | /{noticeId} | 查看详情+浏览计数 |
| 最新公告 | GET | /latest | 获取最新5条 |

---

## 🎨 前端设计

### 1. API定义

**文件**: `src/api/quiz/notice.js`

```javascript
// 主要API
listNotice(query)        // 查询列表
getNotice(noticeId)      // 查询详情
addNotice(data)          // 新增
updateNotice(data)       // 修改
delNotice(noticeId)      // 删除
publishNotice(noticeId)  // 发布
unpublishNotice(noticeId)// 取消发布
```

### 2. 管理页面

**文件**: `src/views/quiz/notice/index.vue`

#### 功能特性
1. **搜索筛选**
   - 公告标题模糊搜索
   - 公告类型筛选
   - 发布状态筛选

2. **列表展示**
   - 公告ID、标题、类型
   - 置顶标记、发布状态
   - 发布时间、浏览次数、排序
   - 操作按钮（修改、发布/下架、删除）

3. **新增/编辑表单**
   - 公告标题（必填，最多200字符）
   - 公告类型（通知/公告/活动）
   - 公告内容（必填，最多2000字符）
   - 是否置顶
   - 排序序号
   - 发布状态（草稿/立即发布）
   - 备注

4. **状态标签**
   - 类型标签：通知(灰)、公告(蓝)、活动(黄)
   - 置顶标签：是(红)
   - 状态标签：已发布(绿)、草稿(灰)

---

## 🔒 权限配置

### 菜单权限

```
公告管理 (C类型菜单)
├─ 公告查询 (F类型按钮) - quiz:notice:query
├─ 公告新增 (F类型按钮) - quiz:notice:add
├─ 公告修改 (F类型按钮) - quiz:notice:edit
├─ 公告删除 (F类型按钮) - quiz:notice:remove
├─ 公告导出 (F类型按钮) - quiz:notice:export
├─ 公告发布 (F类型按钮) - quiz:notice:publish
└─ 公告下架 (F类型按钮) - quiz:notice:unpublish
```

### 配置步骤

1. **执行SQL脚本**
   ```bash
   source sql/2025-11-23/3-公告管理表结构.sql
   source sql/2025-11-23/4-公告管理菜单权限配置.sql
   ```

2. **分配权限**
   - 登录后台管理系统
   - 进入【系统管理】→【角色管理】
   - 选择角色 → 修改 → 勾选"公告管理"菜单及按钮权限
   - 保存

---

## 📊 业务流程

### 1. 发布公告流程

```
创建公告 → 填写信息 → 选择状态
    ↓                      ↓
草稿保存 ←────────────→ 立即发布
    ↓                      ↓
后续发布              前台展示
```

### 2. 数据流向

```
后台管理
  ↓ 创建/编辑公告
  ↓ status=1 发布
数据库
  ↓ 前台API查询
  ↓ 只查询status=1
前台展示
  ↓ 用户查看
浏览次数+1
```

---

## 🚀 部署步骤

### 1. 数据库初始化

```bash
# 1. 创建表结构
mysql -u root -p < sql/2025-11-23/3-公告管理表结构.sql

# 2. 配置菜单权限
mysql -u root -p < sql/2025-11-23/4-公告管理菜单权限配置.sql
```

### 2. 后端部署

```bash
# 重新编译项目
cd daming-admin
mvn clean package

# 重启服务
./restart.sh
```

### 3. 前端部署

```bash
# 无需额外操作，页面和API已创建完成
# 刷新浏览器即可看到新菜单
```

---

## 📁 文件清单

### 后端文件

```
daming-admin/
├─ dm_questionBank/
│  ├─ src/main/java/com/dm/quiz/
│  │  ├─ domain/
│  │  │  └─ DamingNotice.java                    ✅ 实体类
│  │  ├─ mapper/
│  │  │  └─ DamingNoticeMapper.java              ✅ Mapper接口
│  │  └─ service/
│  │     ├─ IDamingNoticeService.java            ✅ Service接口
│  │     └─ impl/
│  │        └─ DamingNoticeServiceImpl.java      ✅ Service实现
│  └─ src/main/resources/mapper/quiz/
│     └─ DamingNoticeMapper.xml                  ✅ Mapper XML
├─ ruoyi-admin/
│  └─ src/main/java/com/ruoyi/web/controller/
│     └─ quiz/
│        ├─ admin/
│        │  └─ DamingNoticeController.java       ✅ 后台Controller
│        └─ student/
│           └─ NoticeController.java             ✅ 前台Controller
└─ sql/2025-11-23/
   ├─ 3-公告管理表结构.sql                        ✅ 数据库SQL
   └─ 4-公告管理菜单权限配置.sql                  ✅ 菜单权限SQL
```

### 前端文件

```
daming-admin/ruoyi-ui/src/
├─ api/quiz/
│  └─ notice.js                                  ✅ API定义
└─ views/quiz/notice/
   └─ index.vue                                  ✅ 管理页面
```

### 文档文件

```
daming-admin/doc/service/2025-11-23/
└─ 13-公告管理模块开发文档.md                     ✅ 本文档
```

---

## 🧪 测试建议

### 1. 后端接口测试

使用Postman测试：

```
# 查询列表
GET http://localhost:8080/quiz/notice/list?pageNum=1&pageSize=10

# 新增公告
POST http://localhost:8080/quiz/notice
Body: {
  "noticeTitle": "测试公告",
  "noticeContent": "这是一条测试公告",
  "noticeType": 1,
  "isTop": 0,
  "status": 0
}

# 发布公告
PUT http://localhost:8080/quiz/notice/publish/1
```

### 2. 前端功能测试

- ✅ 列表查询和分页
- ✅ 新增公告（草稿/发布）
- ✅ 修改公告
- ✅ 删除公告（单个/批量）
- ✅ 发布/下架公告
- ✅ 搜索筛选
- ✅ 导出Excel

### 3. 前台展示测试

```
# 查看公告列表
GET http://localhost:8080/student/notice/list

# 查看公告详情（浏览次数+1）
GET http://localhost:8080/student/notice/1

# 获取最新公告
GET http://localhost:8080/student/notice/latest
```

---

## ⚠️ 注意事项

1. **权限配置**
   - 菜单权限SQL中的`parent_id`需要根据实际题库管理菜单ID调整
   - 默认为2038，请查询实际值后修改

2. **前台展示**
   - 只展示`status=1`（已发布）的公告
   - 自动按置顶、排序、发布时间排序

3. **浏览统计**
   - 前台查看详情时自动增加浏览次数
   - 后台管理查看不计入浏览次数

4. **软删除**
   - 删除操作为软删除，设置`del_flag=1`
   - 不会真正删除数据库记录

---

## 🔄 后续优化建议

### 1. 功能增强
- [ ] 富文本编辑器支持
- [ ] 图片上传功能
- [ ] 定时发布功能
- [ ] 公告有效期设置
- [ ] 公告阅读状态标记

### 2. 性能优化
- [ ] 公告列表缓存
- [ ] 热门公告统计
- [ ] 浏览次数异步更新

### 3. 用户体验
- [ ] 公告搜索优化
- [ ] 公告标签功能
- [ ] 公告评论功能
- [ ] 消息推送通知

---

## 📞 技术支持

如有问题，请联系：daming团队

**文档版本**: v1.0  
**最后更新**: 2025-11-23
