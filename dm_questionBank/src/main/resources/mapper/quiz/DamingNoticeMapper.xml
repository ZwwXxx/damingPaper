<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dm.quiz.mapper.DamingNoticeMapper">

    <resultMap id="DamingNoticeResult" type="com.dm.quiz.domain.DamingNotice">
        <id property="noticeId" column="notice_id"/>
        <result property="noticeTitle" column="notice_title"/>
        <result property="noticeContent" column="notice_content"/>
        <result property="noticeType" column="notice_type"/>
        <result property="isTop" column="is_top"/>
        <result property="status" column="status"/>
        <result property="publishTime" column="publish_time"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="viewCount" column="view_count"/>
        <result property="delFlag" column="del_flag"/>
        <result property="createUser" column="create_user"/>
        <result property="createTime" column="create_time"/>
        <result property="updateUser" column="update_user"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <sql id="selectDamingNoticeVo">
        select notice_id, notice_title, notice_content, notice_type, is_top, status, 
               publish_time, sort_order, view_count, del_flag, create_user, create_time, 
               update_user, update_time, remark
        from daming_notice
    </sql>

    <!-- 查询单个公告 -->
    <select id="selectDamingNoticeByNoticeId" parameterType="java.lang.Long" resultMap="DamingNoticeResult">
        <include refid="selectDamingNoticeVo"/>
        where notice_id = #{noticeId}
          and del_flag = '0'
    </select>

    <!-- 查询公告列表（后台管理） -->
    <select id="selectDamingNoticeList" parameterType="com.dm.quiz.domain.DamingNotice" resultMap="DamingNoticeResult">
        <include refid="selectDamingNoticeVo"/>
        <where>
            <if test="noticeTitle != null and noticeTitle != ''">
                and notice_title like concat('%', #{noticeTitle}, '%')
            </if>
            <if test="noticeType != null">
                and notice_type = #{noticeType}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="isTop != null">
                and is_top = #{isTop}
            </if>
            and del_flag = '0'
        </where>
        order by is_top desc, sort_order desc, create_time desc
    </select>

    <!-- 查询前台展示的公告列表（只查询已发布的） -->
    <select id="selectPublishedNoticeList" parameterType="com.dm.quiz.domain.DamingNotice" resultMap="DamingNoticeResult">
        <include refid="selectDamingNoticeVo"/>
        <where>
            <if test="noticeType != null">
                and notice_type = #{noticeType}
            </if>
            and status = 1
            and del_flag = '0'
        </where>
        order by is_top desc, sort_order desc, publish_time desc
    </select>

    <!-- 新增公告 -->
    <insert id="insertDamingNotice" parameterType="com.dm.quiz.domain.DamingNotice" useGeneratedKeys="true" keyProperty="noticeId">
        insert into daming_notice
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="noticeTitle != null and noticeTitle != ''">notice_title,</if>
            <if test="noticeContent != null">notice_content,</if>
            <if test="noticeType != null">notice_type,</if>
            <if test="isTop != null">is_top,</if>
            <if test="status != null">status,</if>
            <if test="publishTime != null">publish_time,</if>
            <if test="sortOrder != null">sort_order,</if>
            <if test="viewCount != null">view_count,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createUser != null">create_user,</if>
            <if test="updateUser != null">update_user,</if>
            <if test="remark != null">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="noticeTitle != null and noticeTitle != ''">#{noticeTitle},</if>
            <if test="noticeContent != null">#{noticeContent},</if>
            <if test="noticeType != null">#{noticeType},</if>
            <if test="isTop != null">#{isTop},</if>
            <if test="status != null">#{status},</if>
            <if test="publishTime != null">#{publishTime},</if>
            <if test="sortOrder != null">#{sortOrder},</if>
            <if test="viewCount != null">#{viewCount},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createUser != null">#{createUser},</if>
            <if test="updateUser != null">#{updateUser},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <!-- 更新公告 -->
    <update id="updateDamingNotice" parameterType="com.dm.quiz.domain.DamingNotice">
        update daming_notice
        <trim prefix="set" suffixOverrides=",">
            <if test="noticeTitle != null and noticeTitle != ''">notice_title = #{noticeTitle},</if>
            <if test="noticeContent != null">notice_content = #{noticeContent},</if>
            <if test="noticeType != null">notice_type = #{noticeType},</if>
            <if test="isTop != null">is_top = #{isTop},</if>
            <if test="status != null">status = #{status},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            <if test="updateUser != null">update_user = #{updateUser},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where notice_id = #{noticeId}
    </update>

    <!-- 删除公告（软删除） -->
    <delete id="deleteDamingNoticeByNoticeId" parameterType="java.lang.Long">
        update daming_notice
        set del_flag = '1'
        where notice_id = #{noticeId}
    </delete>

    <!-- 批量删除公告（软删除） -->
    <delete id="deleteDamingNoticeByNoticeIds" parameterType="java.lang.Long">
        update daming_notice
        set del_flag = '1'
        where notice_id in
        <foreach collection="array" item="noticeId" open="(" separator="," close=")">
            #{noticeId}
        </foreach>
    </delete>

    <!-- 增加浏览次数 -->
    <update id="incrementViewCount" parameterType="java.lang.Long">
        update daming_notice
        set view_count = view_count + 1
        where notice_id = #{noticeId}
    </update>

</mapper>
